
'cloturer_project.php'
<?php
require_once __DIR__ . '/includes/functions.php';
require_login();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: dashboard.php');
    exit;
}

$project_id = $_POST['project_id'] ?? '';
$user = current_user();

if (!$project_id) {
    header('Location: dashboard.php');
    exit;
}

try {    
    $stmt = $pdo->prepare("UPDATE projects SET status = 'done' WHERE id = ? AND created_by = ?");
    $stmt->execute([$project_id, $user['id']]);
    
    if ($stmt->rowCount() > 0) {
        log_activity($user['id'], 'close_project', "project_$project_id", "Projet cl√¥tur√©");
    }

} catch (Exception $e) {
    // Silencieux
}

header('Location: dashboard.php');
exit;









'create_project.php'
<?php
$page_title = 'Cr√©er un projet';
require_once __DIR__ . '/includes/functions.php';
require_login();

$user = current_user();

// G√©n√©rer un ID unique pour ce projet (sera utilis√© √† la cr√©ation)
$project_id = generate_id('proj_');
?>

<?php include __DIR__ . '/includes/header.php'; ?>

<section class="form-page">
    <h1>Cr√©er un nouveau projet</h1>
    <p>Utilisez ce formulaire pour cr√©er un projet de colocation, de cours ou de voyage et r√©partir les t√¢ches.</p>

    <form method="post" action="save_project.php" class="form-block">
        <input type="hidden" name="project_id" value="<?= htmlspecialchars($project_id) ?>">
        <div class="form-group">
            <label for="project_name">Nom du projet</label>
            <input type="text" id="project_name" name="project_name" required>
        </div>

        <div class="form-group">
            <label for="project_description">Description (facultatif)</label>
            <textarea id="project_description" name="project_description" rows="3"
                placeholder="Ex : Organisation des t√¢ches m√©nag√®res de l‚Äôappartement..."></textarea>
        </div>


        <h2>Membres invit√©s</h2>
        <p class="hint">
            Invitez vos colocataires, camarades de classe ou amis pour le projet.
            Vous √™tes automatiquement inclus comme cr√©ateur.
        </p>
        
        <?php 
        $user = current_user();
        $user_name = htmlspecialchars($user['name'] ?? '');
        $user_email = htmlspecialchars($user['email'] ?? '');
        ?>

        <!--new things added -->
        <button type="button" class="btn-secondary invite-link-btn" onclick="toggleInviteLink()">
            Afficher le lien d‚Äôinvitation
        </button>
        <div id="invite-link-box" class="invite-link-box" style="display: none;">
            <p>Partagez ce lien avec les membres que vous avez ajout√©s&nbsp;:</p>
            <code id="invite-link-code" style="cursor: pointer; padding: 8px 12px; background: #f5f5f5; display: inline-block; border-radius: 4px; border: 1px solid #ddd; user-select: all; transition: all 0.2s;" onmouseover="this.style.background='#e8e8e8'; this.style.borderColor='#999';" onmouseout="this.style.background='#f5f5f5'; this.style.borderColor='#ddd';" onclick="copyInviteLink(this)">https://weshare.alwaysdata.net/?project_id=<?= htmlspecialchars($project_id) ?></code>
            <p id="copy-feedback" style="display: none; color: #4caf50; font-weight: bold; margin-top: 8px;">‚úì Lien copi√© !</p>
            <p class="hint">
                Cliquez sur le lien pour le copier, puis envoyez-le √† vos colocataires / camarades / amis.
                Ils pourront cr√©er un compte ou se connecter, puis voir ce projet dans leur tableau de bord.
            </p>
        </div>

        <div id="members-container">
            <!-- Cr√©ateur du projet (non modifiable) -->
            <div class="member-row" style="background: #f0f0f0; padding: 10px; margin-bottom: 10px; border-radius: 4px; opacity: 0.9;">
                <input type="text" name="member_name[]" value="<?php echo $user_name; ?>" readonly style="flex: 1; background: #e8e8e8;">
                <input type="email" name="member_email[]" value="<?php echo $user_email; ?>" readonly style="flex: 1; background: #e8e8e8;">
                <span style="background: #007bff; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; white-space: nowrap;">Cr√©ateur</span>
            </div>
        </div>
        <div id="members-new-container"></div>
        <button type="button" class="btn-secondary" onclick="addNewMemberRow()">+ Ajouter un membre</button>


        <h2>T√¢ches du projet</h2>
        <p class="hint">
            Cr√©ez les t√¢ches et assignez-les √† un membre du projet.
            Exemple : "Sortir les poubelles", "Pr√©parer le plan du voyage"...
        </p>

        <div id="tasks-container">
            <div class="task-row">
                <input type="text" name="task_title[]" placeholder="Titre de la t√¢che">
                <select name="task_assigned_to[]">
                    <option value="">-- Non assign√© --</option>
                </select>
                <select name="task_mode[]" class="task-mode-select" title="Mode d'√©valuation">
                    <option value="status">Statut</option>
                    <option value="bar">Barre</option>
                </select>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="checkbox" name="task_recurring[]" class="task-recurring-check" onchange="toggleRecurringDays(this)">
                    <span>Hebdomadaire</span>
                </label>
                <button type="button" class="btn-secondary btn-remove" onclick="removeTaskRow(this)">‚úï Supprimer</button>
            </div>
        </div>
        <button type="button" class="btn-secondary" onclick="addTaskRow()">+ Ajouter une t√¢che</button>

        <div class="form-actions">
            <button type="submit" class="btn-primary">Enregistrer le projet</button>
            <a href="dashboard.php" class="btn-link">Annuler</a>
        </div>
    </form>
</section>

<?php include __DIR__ . '/includes/footer.php'; ?>

<script>
// Ensure task assignee dropdowns are populated on page load
document.addEventListener('DOMContentLoaded', function() {
    if (typeof updateTaskAssigneeSelects === 'function') {
        updateTaskAssigneeSelects();
    }
});

// Toggle recurring days selection
function toggleRecurringDays(checkbox) {
    const taskRow = checkbox.closest('.task-row');
    if (!taskRow) return;
    
    // Get the task index to create proper indexed names
    const taskIndex = Array.from(document.querySelectorAll('.task-row')).indexOf(taskRow);
    
    let recurringDaysContainer = taskRow.querySelector('.recurring-days-container');
    
    if (checkbox.checked) {
        if (!recurringDaysContainer) {
            // Create the recurring days selector
            recurringDaysContainer = document.createElement('div');
            recurringDaysContainer.className = 'recurring-days-container';
            recurringDaysContainer.style.cssText = 'display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;';
            
            const days = [
                { label: 'Lun', value: 'mon' },
                { label: 'Mar', value: 'tue' },
                { label: 'Mer', value: 'wed' },
                { label: 'Jeu', value: 'thu' },
                { label: 'Ven', value: 'fri' },
                { label: 'Sam', value: 'sat' },
                { label: 'Dim', value: 'sun' }
            ];
            
            days.forEach(day => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 4px; cursor: pointer;';
                label.innerHTML = `
                    <input type="checkbox" name="task_recurring_days[${taskIndex}][]" value="${day.value}">
                    <span>${day.label}</span>
                `;
                recurringDaysContainer.appendChild(label);
            });
            
            taskRow.appendChild(recurringDaysContainer);
        } else {
            recurringDaysContainer.style.display = 'flex';
        }
    } else {
        if (recurringDaysContainer) {
            recurringDaysContainer.style.display = 'none';
        }
    }
}
</script></script>








'dashboard.php'
<?php
$page_title = 'Mes projets';
require_once __DIR__ . '/includes/functions.php';
require_login();

$user = current_user();
$email = strtolower($user['email']);

$projects = get_full_user_projects($user['id']);

$created_projects = [];
$member_projects = [];

foreach ($projects as $project) {
    if (strtolower($project['creator_email']) === $email) {
        $created_projects[] = $project;
        continue;
    }

    $is_member = false;
    foreach ($project['members'] as $member) {
        if (strtolower($member['email']) === $email) {
            $is_member = true;
            break;
        }
    }
    if ($is_member) {
        $member_projects[] = $project;
    }
}

// l'ordre : actifs d'abord
usort($created_projects, function ($a, $b) {
    return strcmp($a['status'] ?? 'active', $b['status'] ?? 'active');
});

usort($member_projects, function ($a, $b) {
    return strcmp($a['status'] ?? 'active', $b['status'] ?? 'active');
});
?>

<?php include __DIR__ . '/includes/header.php'; ?>

<section>
    <h1>Mes projets</h1>
    <p>Bienvenue sur WeShare. Ici vous pouvez organiser les t√¢ches de colocation, projets d'√©tudes, voyages, etc.</p>

    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <a href="create_project.php" class="btn-primary">+ Cr√©er un nouveau projet</a>
        <a href="weekly_view.php" class="btn-secondary" style="display: inline-block; padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px; cursor: pointer;">üìÖ Vue semaine</a>
        <a href="stats_view.php" class="btn-secondary" style="display: inline-block; padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px; cursor: pointer;">üìä Statistiques</a>
    </div>
</section>

<!-- Recent Tasks Section -->
<section class="project-section">
    <h2>üìã Mes t√¢ches r√©centes</h2>
    <?php
    // Collect all tasks from all projects (created + member)
    $all_my_tasks = [];
    foreach (array_merge($created_projects, $member_projects) as $project) {
        foreach ($project['tasks'] as $task) {
            if (strtolower($task['assigned_to']) === $email) {
                $all_my_tasks[] = [
                    'task' => $task,
                    'project' => $project,
                ];
            }
        }
    }
    
    // Sort by creation order (most recent first) - we'll show the 10 most recent
    $recent_tasks = array_slice($all_my_tasks, 0, 10);
    ?>
    
    <?php if (!$recent_tasks): ?>
        <p>Aucune t√¢che ne vous est assign√©e pour le moment.</p>
    <?php else: ?>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
        <?php foreach ($recent_tasks as $item): 
            $task = $item['task'];
            $project = $item['project'];
            $isBarMode = ($task['mode'] ?? 'status') === 'bar';
            $isRecurring = $task['is_recurring'] ?? false;
            
            // For recurring tasks, determine the relevant date (today or next occurrence)
            $relevantDate = null;
            if ($isRecurring) {
                $dayMap = ['sun' => 0, 'mon' => 1, 'tue' => 2, 'wed' => 3, 'thu' => 4, 'fri' => 5, 'sat' => 6];
                $today = new DateTime();
                $currentDayNum = $today->format('w'); // 0=Sun, 1=Mon, etc.
                
                // Find the next occurrence of this task
                $minDaysAhead = 7;
                $nextOccurrence = null;
                foreach ($task['recurring_days'] ?? [] as $day) {
                    $targetDayNum = $dayMap[$day] ?? null;
                    if ($targetDayNum === null) continue;
                    $daysAhead = ($targetDayNum - $currentDayNum + 7) % 7;
                    if ($daysAhead < $minDaysAhead) {
                        $minDaysAhead = $daysAhead;
                        $nextOccurrence = $daysAhead;
                    }
                }
                
                if ($nextOccurrence !== null) {
                    $relevantDate = new DateTime();
                    $relevantDate->modify("+{$nextOccurrence} days");
                    $relevantDate = $relevantDate->format('Y-m-d');
                }
            }
            
            // Determine completion status using is_task_complete function
            $isCompleted = is_task_complete($task, $relevantDate);
            
            // Get display values (daily values for recurring tasks, global for non-recurring)
            if ($isRecurring && $relevantDate) {
                if ($isBarMode) {
                    $displayProgress = get_daily_progress($task, $relevantDate);
                    $displayStatus = null;
                } else {
                    $displayStatus = get_daily_status($task, $relevantDate);
                    $displayProgress = null;
                }
            } else {
                $displayProgress = $task['progress'] ?? 0;
                $displayStatus = $task['status'] ?? 'todo';
            }
            
            $bgColor = $isCompleted ? '#e8f5e9' : '#f5f5f5';
            $borderColor = $isCompleted ? '#4caf50' : '#ddd';
            $statusIcon = $isCompleted ? '‚úì' : '‚Üí';
            $statusColor = $isCompleted ? '#4caf50' : '#ff9800';
        ?>
            <div style="background: <?= $bgColor ?>; border: 2px solid <?= $borderColor ?>; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; color: #333;"><?= htmlspecialchars($task['title']) ?></h4>
                        <small style="color: #666; font-size: 0.85em;">üìÅ <?= htmlspecialchars($project['name']) ?></small>
                        <?php if ($isRecurring): ?>
                            <br><small style="color: #666; font-size: 0.85em;">üìÖ <?= htmlspecialchars(format_recurring_days($task['recurring_days'] ?? [])) ?></small>
                            <?php if ($relevantDate): ?>
                                <br><small style="color: #0066cc; font-size: 0.85em; font-weight: bold;">üìÜ <?= htmlspecialchars(date('d/m/Y', strtotime($relevantDate))) ?></small>
                            <?php endif; ?>
                        <?php endif; ?>
                    </div>
                    <span style="font-size: 1.5em; color: <?= $statusColor ?>;"><?= $statusIcon ?></span>
                </div>
                
                <?php if ($isBarMode): ?>
                    <div style="background: #ddd; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: <?= $displayProgress ?>%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75em; font-weight: bold;">
                            <?php if ($displayProgress > 10): ?><?= $displayProgress ?>%<?php endif; ?>
                        </div>
                    </div>
                <?php else: ?>
                    <div style="padding: 8px 12px; background: #fff; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-weight: 500; color: #333;">
                        <?php 
                        $statusLabels = ['todo' => '‚è≥ √Ä faire', 'in_progress' => 'üîÑ En cours', 'done' => '‚úì Termin√©'];
                        echo $statusLabels[$displayStatus] ?? '√Ä faire';
                        ?>
                    </div>
                <?php endif; ?>
            </div>
        <?php endforeach; ?>
        </div>
    <?php endif; ?>
</section>

<section class="project-section">
    <h2>Projets que j'ai cr√©√©s</h2>
    <?php if (!$created_projects): ?>
        <p>Vous n‚Äôavez pas encore cr√©√© de projet.</p>
    <?php else: ?>
        <?php foreach ($created_projects as $project): ?>
            <article class="project-card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; gap: 10px;">
                    <h3 style="margin: 0; flex: 1;"><?= htmlspecialchars($project['name']) ?></h3>
                    <div style="display: flex; gap: 6px; flex-shrink: 0;">
                        <?php if (($project['status'] ?? 'active') !== 'done'): ?>
                            <a href="modify_project.php?id=<?= htmlspecialchars($project['id']) ?>" 
                               class="btn-secondary" 
                               style="display: inline-block; padding: 6px 12px; font-size: 0.85em;">
                                ‚úèÔ∏è Modifier
                            </a>
                            <form method="post" action="cloturer_project.php" style="margin:0; display: inline;">
                                <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                <button type="submit" class="btn-secondary"
                                    onclick="return confirm('√ätes-vous s√ªr de vouloir cl√¥turer ce projet ?')"
                                    style="display:inline-block; padding: 6px 12px; font-size: 0.85em;">
                                    ‚úì Cl√¥turer
                                </button>
                            </form>
                        <?php else: ?>
                            <span style="color: green; font-weight: bold; padding: 6px 12px; font-size: 0.85em;">‚úì Termin√©</span>
                            <form method="post" action="reactiver_project.php" style="margin:0; display: inline;">
                                <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                <button type="submit" class="btn-secondary"
                                    style="display:inline-block; background-color: #1e90ff; color: white; padding: 6px 12px; font-size: 0.85em;">
                                    üîÑ R√©activer
                                </button>
                            </form>
                            <form method="post" action="delete_project.php" style="margin:0; display: inline;">
                                <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                <button type="submit" class="btn-secondary"
                                    onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer ce projet ?')"
                                    style="display:inline-block; background-color: #e74c3c; color: white; padding: 6px 12px; font-size: 0.85em;">
                                    üóëÔ∏è Supprimer
                                </button>
                            </form>
                        <?php endif; ?>
                    </div>
                </div>
                <?php if (!empty($project['description'])): ?>
                    <p class="project-desc"><?= nl2br(htmlspecialchars($project['description'])) ?></p>
                <?php endif; ?>

                <p class="project-meta">
                    Cr√©ateur : <?= htmlspecialchars($project['creator_name']) ?>
                    (<?= htmlspecialchars($project['creator_email']) ?>)
                </p>

                <h4>Membres</h4>
                <?php if (empty($project['members'])): ?>
                    <p>Aucun membre invit√©.</p>
                <?php else: ?>
                    <ul>
                        <?php foreach ($project['members'] as $member):
                            $is_creator_member = (strtolower($member['email']) === strtolower($project['creator_email']));
                            // Check if this member has accepted (is in their member_projects)
                            $member_has_accepted = false;
                            if (!$is_creator_member) {
                                foreach ($projects as $p) {
                                    if ($p['id'] === $project['id']) {
                                        // Check if member is in this project's members list and it's in THEIR member_projects
                                        foreach ($p['members'] as $m) {
                                            if (strtolower($m['email']) === strtolower($member['email'])) {
                                                // Now check if this member would see this project as a member project
                                                // by checking if they're NOT the creator
                                                if (strtolower($p['creator_email']) !== strtolower($member['email'])) {
                                                    $member_has_accepted = true;
                                                }
                                                break;
                                            }
                                        }
                                        break;
                                    }
                                }
                            }
                            ?>
                            <li>
                                <?= htmlspecialchars($member['name']) ?> - <?= htmlspecialchars($member['email']) ?>
                                <?php if (!$is_creator_member && !$member_has_accepted): ?>
                                    <span class="badge badge-pending">Invitation en attente</span>
                                <?php endif; ?>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>



                <h4>T√¢ches</h4>
                <?php if (empty($project['tasks'])): ?>
                    <div class="tasks-toggle">
                        <button class="btn-toggle active" data-project="<?= htmlspecialchars($project['id']) ?>" data-view="mine" onclick="toggleTasksView('<?= htmlspecialchars($project['id']) ?>')">Mes t√¢ches</button>
                        <button class="btn-toggle" data-project="<?= htmlspecialchars($project['id']) ?>" data-view="all" onclick="toggleTasksView('<?= htmlspecialchars($project['id']) ?>')">Toutes les t√¢ches</button>
                    </div>
                    <div class="table-wrapper" data-project="<?= htmlspecialchars($project['id']) ?>" data-table="mine">
                        <p>Ce projet n'a pas encore de t√¢che.</p>
                    </div>
                    <div class="table-wrapper" data-project="<?= htmlspecialchars($project['id']) ?>" data-table="all" style="display: none;">
                        <p>Ce projet n'a pas encore de t√¢che.</p>
                    </div>
                <?php else: ?>
                    <div class="tasks-toggle">
                        <button class="btn-toggle active" data-project="<?= htmlspecialchars($project['id']) ?>" data-view="mine" onclick="toggleTasksView('<?= htmlspecialchars($project['id']) ?>')">Mes t√¢ches</button>
                        <button class="btn-toggle" data-project="<?= htmlspecialchars($project['id']) ?>" data-view="all" onclick="toggleTasksView('<?= htmlspecialchars($project['id']) ?>')">Toutes les t√¢ches</button>
                    </div>

                    <?php
                    $is_done = ($project['status'] ?? 'active') === 'done';
                    $my_tasks = array_filter($project['tasks'], function ($task) use ($email) {
                        return strtolower($task['assigned_to']) === $email;
                    });
                    ?>

                    <?php if (!$my_tasks): ?>
                        <p>Aucune t√¢che ne vous est assign√©e.</p>
                    <?php else: ?>
                        <div class="table-wrapper" data-project="<?= htmlspecialchars($project['id']) ?>" data-table="mine">
                            <table>
                                <thead>
                                    <tr>
                                        <th>T√¢che</th>
                                        <th>Assign√© √†</th>
                                        <th>√âtat</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($project['tasks'] as $task): ?>
                                        <?php $is_my_task = (strtolower($task['assigned_to']) === $email); ?>
                                        <?php if (strtolower($task['assigned_to']) === $email): ?>
                                            <?php
                                            // For recurring tasks, get the relevant date and display values
                                            $relevantDate = null;
                                            $displayStatus = $task['status'] ?? 'todo';
                                            $displayProgress = $task['progress'] ?? 0;
                                            $taskIsCompleted = is_task_complete($task);
                                            
                                            if ($task['is_recurring'] ?? false) {
                                                $relevantDate = get_relevant_date_for_recurring_task($task);
                                                if ($relevantDate) {
                                                    $taskIsCompleted = is_task_complete($task, $relevantDate);
                                                    if (($task['mode'] ?? 'status') === 'bar') {
                                                        $displayProgress = get_daily_progress($task, $relevantDate);
                                                    } else {
                                                        $displayStatus = get_daily_status($task, $relevantDate);
                                                    }
                                                }
                                            }
                                            
                                            $bgColor = $taskIsCompleted ? '#e8f5e9' : 'transparent';
                                            ?>
                                            <tr class="my-task <?= $taskIsCompleted ? 'task-completed' : '' ?>" data-task-id="<?= htmlspecialchars($task['id']) ?>" data-project-id="<?= htmlspecialchars($project['id']) ?>" data-task-mode="<?= htmlspecialchars($task['mode'] ?? 'status') ?>" style="background-color: <?= $bgColor ?>;">
                                                <td>
                                                    <?= htmlspecialchars($task['title']) ?>
                                                    <?php if ($task['is_recurring'] ?? false): ?>
                                                        <br><small style="color: #666; font-size: 0.85em;">üìÖ <?= htmlspecialchars(format_recurring_days($task['recurring_days'] ?? [])) ?></small>
                                                        <?php if ($relevantDate): ?>
                                                            <br><small style="color: #0066cc; font-size: 0.85em; font-weight: bold;">üìÜ <?= htmlspecialchars(date('d/m', strtotime($relevantDate))) ?></small>
                                                        <?php endif; ?>
                                                    <?php endif; ?>
                                                </td>
                                                <td><?= htmlspecialchars($task['assigned_to'] ?: 'Non assign√©') ?></td>
                                                <td>
                                                    <?php if ($task['is_recurring'] ?? false): ?>
                                                        <!-- Recurring task: show day selector -->
                                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                                <?php 
                                                                $dayNames = ['mon' => 'Lun', 'tue' => 'Mar', 'wed' => 'Mer', 'thu' => 'Jeu', 'fri' => 'Ven', 'sat' => 'Sam', 'sun' => 'Dim'];
                                                                foreach ($task['recurring_days'] ?? [] as $day):
                                                                    ?>
                                                                    <button class="day-btn" data-day="<?= htmlspecialchars($day) ?>" onclick="selectTaskDay(this, '<?= htmlspecialchars($project['id']) ?>', '<?= htmlspecialchars($task['id']) ?>', '<?= htmlspecialchars($task['mode'] ?? 'status') ?>')" style="padding: 6px 10px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: bold;">
                                                                        <?= $dayNames[$day] ?>
                                                                    </button>
                                                                <?php endforeach; ?>
                                                            </div>
                                                            <div class="task-day-content" style="display: none;">
                                                                <?php if (($task['mode'] ?? 'status') === 'bar'): ?>
                                                                    <div class="progress-bar">
                                                                        <div class="progress-fill" style="width: 0%"></div>
                                                                        <span class="progress-text">0%</span>
                                                                    </div>
                                                                    <form method="post" action="update_task.php" style="margin-top: 8px;">
                                                                        <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                                        <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                                        <input type="hidden" name="date" value="">
                                                                        <input type="range" name="progress" min="0" max="100" value="0" 
                                                                               class="progress-slider" onchange="<?= $is_done ? 'return false;' : 'return updateTaskAjax(this.form)' ?>" style="width: 100%; cursor: <?= $is_done ? 'default' : 'pointer' ?>;" <?= $is_done ? 'disabled' : '' ?>>
                                                                    </form>
                                                                <?php else: ?>
                                                                    <form method="post" action="update_task.php">
                                                                        <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                                        <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                                        <input type="hidden" name="date" value="">
                                                                        <select name="status" onchange="<?= $is_done ? 'return false;' : 'return updateTaskAjax(this.form)' ?>" <?= $is_done ? 'disabled' : '' ?>>
                                                                            <option value="todo">√Ä faire</option>
                                                                            <option value="in_progress">En cours</option>
                                                                            <option value="done">Termin√©</option>
                                                                        </select>
                                                                    </form>
                                                                <?php endif; ?>
                                                            </div>
                                                        </div>
                                                    <?php else: ?>
                                                        <!-- Non-recurring task -->
                                                        <?php if (($task['mode'] ?? 'status') === 'bar'): ?>
                                                            <div class="progress-bar">
                                                                <div class="progress-fill" style="width: <?= $displayProgress ?>%"></div>
                                                                <span class="progress-text"><?= $displayProgress ?>%</span>
                                                            </div>
                                                            <?php if (!$is_done): ?>
                                                                <form method="post" action="update_task.php" style="margin-top: 8px;">
                                                                    <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                                    <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                                    <input type="range" name="progress" min="0" max="100" value="<?= $displayProgress ?>" 
                                                                           class="progress-slider" onchange="return updateTaskAjax(this.form)" style="width: 100%; cursor: pointer;">
                                                                </form>
                                                            <?php else: ?>
                                                                <button type="button" class="btn-delete" onclick="return deleteTaskAjax('<?= htmlspecialchars($project['id']) ?>', '<?= htmlspecialchars($task['id']) ?>')" style="margin-top: 8px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">üóëÔ∏è Supprimer</button>
                                                            <?php endif; ?>
                                                        <?php else: ?>
                                                            <?php if ($is_my_task && !$is_done): ?>
                                                                <form method="post" action="update_task.php">
                                                                    <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                                    <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                                    <select name="status" onchange="return updateTaskAjax(this.form)">
                                                                        <option value="todo" <?= $displayStatus === 'todo' ? 'selected' : '' ?>>√Ä faire</option>
                                                                        <option value="in_progress" <?= $displayStatus === 'in_progress' ? 'selected' : '' ?>>En cours</option>
                                                                        <option value="done" <?= $displayStatus === 'done' ? 'selected' : '' ?>>Termin√©</option>
                                                                    </select>
                                                                </form>
                                                            <?php else: ?>
                                                                <?= htmlspecialchars(status_label($displayStatus)) ?>
                                                                <?php if ($taskIsCompleted): ?>
                                                                    <button type="button" class="btn-delete" onclick="return deleteTaskAjax('<?= htmlspecialchars($project['id']) ?>', '<?= htmlspecialchars($task['id']) ?>')" style="margin-left: 8px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">üóëÔ∏è</button>
                                                                <?php endif; ?>
                                                            <?php endif; ?>
                                                        <?php endif; ?>
                                                    <?php endif; ?>
                                                </td>
                                            </tr>
                                        <?php endif; ?>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    <?php endif; ?>

                    <div class="table-wrapper" data-project="<?= htmlspecialchars($project['id']) ?>" data-table="all" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√¢che</th>
                                    <th>Assign√© √†</th>
                                    <th>√âtat</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($project['tasks'] as $task): ?>
                                    <?php 
                                    $is_my_task = (strtolower($task['assigned_to']) === $email);
                                    
                                    // For recurring tasks, get the relevant date and display values
                                    $relevantDate = null;
                                    $displayStatus = $task['status'] ?? 'todo';
                                    $displayProgress = $task['progress'] ?? 0;
                                    $taskIsCompleted = is_task_complete($task);
                                    
                                    if ($task['is_recurring'] ?? false) {
                                        $relevantDate = get_relevant_date_for_recurring_task($task);
                                        if ($relevantDate) {
                                            $taskIsCompleted = is_task_complete($task, $relevantDate);
                                            if (($task['mode'] ?? 'status') === 'bar') {
                                                $displayProgress = get_daily_progress($task, $relevantDate);
                                            } else {
                                                $displayStatus = get_daily_status($task, $relevantDate);
                                            }
                                        }
                                    }
                                    
                                    $bgColor = $taskIsCompleted ? '#e8f5e9' : 'transparent';
                                    ?>
                                    <tr class="<?= $is_my_task ? 'my-task' : '' ?> <?= $taskIsCompleted ? 'task-completed' : '' ?>" data-task-id="<?= htmlspecialchars($task['id']) ?>" data-project-id="<?= htmlspecialchars($project['id']) ?>" data-task-mode="<?= htmlspecialchars($task['mode'] ?? 'status') ?>" style="background-color: <?= $bgColor ?>;">
                                        <td>
                                            <?= htmlspecialchars($task['title']) ?>
                                            <?php if ($task['is_recurring'] ?? false): ?>
                                                <br><small style="color: #666; font-size: 0.85em;">üìÖ <?= htmlspecialchars(format_recurring_days($task['recurring_days'] ?? [])) ?></small>
                                                <?php if ($relevantDate): ?>
                                                    <br><small style="color: #0066cc; font-size: 0.85em; font-weight: bold;">üìÜ <?= htmlspecialchars(date('d/m', strtotime($relevantDate))) ?></small>
                                                <?php endif; ?>
                                            <?php endif; ?>
                                        </td>
                                        <td><?= htmlspecialchars($task['assigned_to'] ?: 'Non assign√©') ?></td>
                                        <td>
                                            <?php if ($task['is_recurring'] ?? false): ?>
                                                <!-- Recurring task: show day selector -->
                                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                        <?php 
                                                        $dayNames = ['mon' => 'Lun', 'tue' => 'Mar', 'wed' => 'Mer', 'thu' => 'Jeu', 'fri' => 'Ven', 'sat' => 'Sam', 'sun' => 'Dim'];
                                                        foreach ($task['recurring_days'] ?? [] as $day):
                                                            ?>
                                                            <button class="day-btn" data-day="<?= htmlspecialchars($day) ?>" onclick="selectTaskDay(this, '<?= htmlspecialchars($project['id']) ?>', '<?= htmlspecialchars($task['id']) ?>', '<?= htmlspecialchars($task['mode'] ?? 'status') ?>')" style="padding: 6px 10px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: bold;">
                                                                <?= $dayNames[$day] ?>
                                                            </button>
                                                        <?php endforeach; ?>
                                                    </div>
                                                    <div class="task-day-content" style="display: none;">
                                                        <?php if (($task['mode'] ?? 'status') === 'bar'): ?>
                                                            <div class="progress-bar">
                                                                <div class="progress-fill" style="width: 0%"></div>
                                                                <span class="progress-text">0%</span>
                                                            </div>
                                                            <form method="post" action="update_task.php" style="margin-top: 8px;">
                                                                <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                                <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                                <input type="hidden" name="date" value="">
                                                                <input type="range" name="progress" min="0" max="100" value="0" 
                                                                       class="progress-slider" onchange="<?= $is_my_task && !$is_done ? 'return updateTaskAjax(this.form)' : 'return false;' ?>" style="width: 100%; cursor: <?= $is_my_task && !$is_done ? 'pointer' : 'default' ?>;" <?= (!$is_my_task || $is_done) ? 'disabled' : '' ?>>
                                                            </form>
                                                        <?php else: ?>
                                                            <form method="post" action="update_task.php">
                                                                <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                                <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                                <input type="hidden" name="date" value="">
                                                                <select name="status" onchange="<?= $is_my_task && !$is_done ? 'return updateTaskAjax(this.form)' : 'return false;' ?>" <?= (!$is_my_task || $is_done) ? 'disabled' : '' ?>>
                                                                    <option value="todo">√Ä faire</option>
                                                                    <option value="in_progress">En cours</option>
                                                                    <option value="done">Termin√©</option>
                                                                </select>
                                                            </form>
                                                        <?php endif; ?>
                                                    </div>
                                                </div>
                                            <?php else: ?>
                                                <!-- Non-recurring task -->
                                                <?php if (($task['mode'] ?? 'status') === 'bar'): ?>
                                                    <div class="progress-bar">
                                                        <div class="progress-fill" style="width: <?= $displayProgress ?>%"></div>
                                                        <span class="progress-text"><?= $displayProgress ?>%</span>
                                                    </div>
                                                    <?php if ($is_my_task && !$is_done): ?>
                                                        <form method="post" action="update_task.php" style="margin-top: 8px;">
                                                            <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                            <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                            <input type="range" name="progress" min="0" max="100" value="<?= $displayProgress ?>" 
                                                                   class="progress-slider" onchange="return updateTaskAjax(this.form)" style="width: 100%; cursor: pointer;">
                                                        </form>
                                                    <?php elseif ($is_my_task && $taskIsCompleted): ?>
                                                        <button type="button" class="btn-delete" onclick="return deleteTaskAjax('<?= htmlspecialchars($project['id']) ?>', '<?= htmlspecialchars($task['id']) ?>')" style="margin-top: 8px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">üóëÔ∏è Supprimer</button>
                                                    <?php endif; ?>
                                                <?php else: ?>
                                                    <?php if ($is_my_task && !$is_done): ?>
                                                        <form method="post" action="update_task.php">
                                                            <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                            <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                            <select name="status" onchange="return updateTaskAjax(this.form)">
                                                                <option value="todo" <?= $displayStatus === 'todo' ? 'selected' : '' ?>>√Ä faire</option>
                                                                <option value="in_progress" <?= $displayStatus === 'in_progress' ? 'selected' : '' ?>>En cours</option>
                                                                <option value="done" <?= $displayStatus === 'done' ? 'selected' : '' ?>>Termin√©</option>
                                                            </select>
                                                        </form>
                                                    <?php else: ?>
                                                        <?= htmlspecialchars(status_label($displayStatus)) ?>
                                                        <?php if ($taskIsCompleted): ?>
                                                            <button type="button" class="btn-delete" onclick="return deleteTaskAjax('<?= htmlspecialchars($project['id']) ?>', '<?= htmlspecialchars($task['id']) ?>')" style="margin-left: 8px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">üóëÔ∏è</button>
                                                        <?php endif; ?>
                                                    <?php endif; ?>
                                                <?php endif; ?>
                                            <?php endif; ?>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                <?php endif; ?>
            </article>
        <?php endforeach; ?>
    <?php endif; ?>
</section>

<section class="project-section">
    <h2>Projets o√π je suis membre</h2>
    <?php if (!$member_projects): ?>
        <p>Vous n‚Äô√™tes membre d‚Äôaucun projet pour l‚Äôinstant.</p>
    <?php else: ?>
        <?php foreach ($member_projects as $project): ?>
            <article class="project-card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; gap: 10px;">
                    <h3 style="margin: 0; flex: 1;"><?= htmlspecialchars($project['name']) ?></h3>
                    <div style="display: flex; gap: 6px; flex-shrink: 0;">
                        <?php if (($project['status'] ?? 'active') !== 'done'): ?>
                            <a href="modify_project.php?id=<?= htmlspecialchars($project['id']) ?>" 
                               class="btn-secondary" 
                               style="display: inline-block; padding: 6px 12px; font-size: 0.85em;">
                                ‚úèÔ∏è Modifier
                            </a>
                        <?php else: ?>
                            <span style="color: green; font-weight: bold; padding: 6px 12px; font-size: 0.85em;">‚úì Termin√©</span>
                            <?php if (strtolower($project['creator_email']) === $email): ?>
                                <form method="post" action="reactiver_project.php" style="margin:0; display: inline;">
                                    <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                    <button type="submit" class="btn-secondary"
                                        style="display:inline-block; background-color: #1e90ff; color: white; padding: 6px 12px; font-size: 0.85em;">
                                        üîÑ R√©activer
                                    </button>
                                </form>
                            <?php endif; ?>
                        <?php endif; ?>
                    </div>
                </div>
                <?php if (!empty($project['description'])): ?>
                    <p class="project-desc"><?= nl2br(htmlspecialchars($project['description'])) ?></p>
                <?php endif; ?>

                <p class="project-meta">
                    Cr√©ateur : <?= htmlspecialchars($project['creator_name']) ?>
                    (<?= htmlspecialchars($project['creator_email']) ?>)
                </p>

                <h4>Membres</h4>
                <?php if (empty($project['members'])): ?>
                    <p>Aucun membre invit√©.</p>
                <?php else: ?>
                    <ul>
                        <?php foreach ($project['members'] as $member): ?>
                            <li><?= htmlspecialchars($member['name']) ?> - <?= htmlspecialchars($member['email']) ?></li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>

                <h4>Mes t√¢ches dans ce projet</h4>
                <?php
                $my_tasks = array_filter($project['tasks'], function ($task) use ($email) {
                    return strtolower($task['assigned_to']) === $email;
                });
                $is_done = ($project['status'] ?? 'active') === 'done';
                ?>

                <div class="tasks-toggle">
                    <button class="btn-toggle active" data-project="<?= htmlspecialchars($project['id']) ?>" data-view="mine" onclick="toggleTasksView('<?= htmlspecialchars($project['id']) ?>')">Mes t√¢ches</button>
                    <button class="btn-toggle" data-project="<?= htmlspecialchars($project['id']) ?>" data-view="all" onclick="toggleTasksView('<?= htmlspecialchars($project['id']) ?>')">Toutes les t√¢ches</button>
                </div>

                <?php if (!$my_tasks): ?>
                    <p>Aucune t√¢che ne vous est assign√©e.</p>
                <?php else: ?>
                    <div class="table-wrapper" data-project="<?= htmlspecialchars($project['id']) ?>" data-table="mine">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√¢che</th>
                                    <th>Assign√© √†</th>
                                    <th>√âtat</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($my_tasks as $task): 
                                    // For recurring tasks, get the relevant date and display values
                                    $is_my_task = true; // We're already filtering by $my_tasks, so this is always true
                                    $relevantDate = null;
                                    $displayStatus = $task['status'] ?? 'todo';
                                    $displayProgress = $task['progress'] ?? 0;
                                    $taskIsCompleted = is_task_complete($task);
                                    
                                    if ($task['is_recurring'] ?? false) {
                                        $relevantDate = get_relevant_date_for_recurring_task($task);
                                        if ($relevantDate) {
                                            $taskIsCompleted = is_task_complete($task, $relevantDate);
                                            if (($task['mode'] ?? 'status') === 'bar') {
                                                $displayProgress = get_daily_progress($task, $relevantDate);
                                            } else {
                                                $displayStatus = get_daily_status($task, $relevantDate);
                                            }
                                        }
                                    }
                                    
                                    $bgColor = $taskIsCompleted ? '#e8f5e9' : 'transparent';
                                ?>
                                    <tr class="my-task <?= $taskIsCompleted ? 'task-completed' : '' ?>" data-task-id="<?= htmlspecialchars($task['id']) ?>" data-project-id="<?= htmlspecialchars($project['id']) ?>" data-task-mode="<?= htmlspecialchars($task['mode'] ?? 'status') ?>" style="background-color: <?= $bgColor ?>;">
                                        <td>
                                            <?= htmlspecialchars($task['title']) ?>
                                            <?php if ($task['is_recurring'] ?? false): ?>
                                                <br><small style="color: #666; font-size: 0.85em;">üìÖ <?= htmlspecialchars(format_recurring_days($task['recurring_days'] ?? [])) ?></small>
                                                <?php if ($relevantDate): ?>
                                                    <br><small style="color: #0066cc; font-size: 0.85em; font-weight: bold;">üìÜ <?= htmlspecialchars(date('d/m', strtotime($relevantDate))) ?></small>
                                                <?php endif; ?>
                                            <?php endif; ?>
                                        </td>
                                        <td><?= htmlspecialchars($task['assigned_to'] ?: 'Non assign√©') ?></td>
                                        <td>
                                            <?php if ($task['is_recurring'] ?? false): ?>
                                                <!-- Recurring task: show day selector -->
                                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                        <?php 
                                                        $dayNames = ['mon' => 'Lun', 'tue' => 'Mar', 'wed' => 'Mer', 'thu' => 'Jeu', 'fri' => 'Ven', 'sat' => 'Sam', 'sun' => 'Dim'];
                                                        foreach ($task['recurring_days'] ?? [] as $day):
                                                            ?>
                                                            <button class="day-btn" data-day="<?= htmlspecialchars($day) ?>" onclick="selectTaskDay(this, '<?= htmlspecialchars($project['id']) ?>', '<?= htmlspecialchars($task['id']) ?>', '<?= htmlspecialchars($task['mode'] ?? 'status') ?>')" style="padding: 6px 10px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: bold;">
                                                                <?= $dayNames[$day] ?>
                                                            </button>
                                                        <?php endforeach; ?>
                                                    </div>
                                                    <div class="task-day-content" style="display: none;">
                                                        <?php if (($task['mode'] ?? 'status') === 'bar'): ?>
                                                            <div class="progress-bar">
                                                                <div class="progress-fill" style="width: 0%"></div>
                                                                <span class="progress-text">0%</span>
                                                            </div>
                                                            <form method="post" action="update_task.php" style="margin-top: 8px;">
                                                                <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                                <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                                <input type="hidden" name="date" value="">
                                                                <input type="range" name="progress" min="0" max="100" value="0" 
                                                                       class="progress-slider" onchange="<?= !$is_done ? 'return updateTaskAjax(this.form)' : 'return false;' ?>" style="width: 100%; cursor: <?= !$is_done ? 'pointer' : 'default' ?>;" <?= $is_done ? 'disabled' : '' ?>>
                                                            </form>
                                                        <?php else: ?>
                                                            <form method="post" action="update_task.php">
                                                                <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                                <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                                <input type="hidden" name="date" value="">
                                                                <select name="status" onchange="<?= !$is_done ? 'return updateTaskAjax(this.form)' : 'return false;' ?>" <?= $is_done ? 'disabled' : '' ?>>
                                                                    <option value="todo">√Ä faire</option>
                                                                    <option value="in_progress">En cours</option>
                                                                    <option value="done">Termin√©</option>
                                                                </select>
                                                            </form>
                                                        <?php endif; ?>
                                                    </div>
                                                </div>
                                            <?php else: ?>
                                                <!-- Non-recurring task -->
                                                <?php if (($task['mode'] ?? 'status') === 'bar'): ?>
                                                    <div class="progress-bar">
                                                        <div class="progress-fill" style="width: <?= $displayProgress ?>%"></div>
                                                        <span class="progress-text"><?= $displayProgress ?>%</span>
                                                    </div>
                                                    <?php if (!$is_done): ?>
                                                        <form method="post" action="update_task.php" style="margin-top: 8px;">
                                                            <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                            <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                            <input type="range" name="progress" min="0" max="100" value="<?= $displayProgress ?>" 
                                                                   class="progress-slider" onchange="return updateTaskAjax(this.form)" style="width: 100%; cursor: pointer;">
                                                        </form>
                                                    <?php endif; ?>
                                                <?php else: ?>
                                                    <?php if (!$is_done): ?>
                                                        <form method="post" action="update_task.php">
                                                            <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                            <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                            <select name="status" onchange="return updateTaskAjax(this.form)">
                                                                <option value="todo" <?= $displayStatus === 'todo' ? 'selected' : '' ?>>√Ä faire</option>
                                                                <option value="in_progress" <?= $displayStatus === 'in_progress' ? 'selected' : '' ?>>En cours</option>
                                                                <option value="done" <?= $displayStatus === 'done' ? 'selected' : '' ?>>Termin√©</option>
                                                            </select>
                                                        </form>
                                                    <?php endif; ?>
                                                <?php endif; ?>
                                            <?php endif; ?>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                <?php endif; ?>

                <div class="table-wrapper" data-project="<?= htmlspecialchars($project['id']) ?>" data-table="all" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>T√¢che</th>
                                <th>Assign√© √†</th>
                                <th>√âvaluation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($project['tasks'] as $task): 
                                $is_my_task = (strtolower($task['assigned_to']) === $email);
                                
                                // For recurring tasks, get the relevant date and display values
                                $relevantDate = null;
                                $displayStatus = $task['status'] ?? 'todo';
                                $displayProgress = $task['progress'] ?? 0;
                                $taskIsCompleted = is_task_complete($task);
                                
                                if ($task['is_recurring'] ?? false) {
                                    $relevantDate = get_relevant_date_for_recurring_task($task);
                                    if ($relevantDate) {
                                        $taskIsCompleted = is_task_complete($task, $relevantDate);
                                        if (($task['mode'] ?? 'status') === 'bar') {
                                            $displayProgress = get_daily_progress($task, $relevantDate);
                                        } else {
                                            $displayStatus = get_daily_status($task, $relevantDate);
                                        }
                                    }
                                }
                                
                                $bgColor = $taskIsCompleted ? '#e8f5e9' : 'transparent';
                            ?>
                                <tr class="<?= $is_my_task ? 'my-task' : '' ?> <?= $taskIsCompleted ? 'task-completed' : '' ?>" data-task-id="<?= htmlspecialchars($task['id']) ?>" data-project-id="<?= htmlspecialchars($project['id']) ?>" data-task-mode="<?= htmlspecialchars($task['mode'] ?? 'status') ?>" style="background-color: <?= $bgColor ?>;">
                                    <td>
                                        <?= htmlspecialchars($task['title']) ?>
                                        <?php if ($task['is_recurring'] ?? false): ?>
                                            <br><small style="color: #666; font-size: 0.85em;">üìÖ <?= htmlspecialchars(format_recurring_days($task['recurring_days'] ?? [])) ?></small>
                                            <?php if ($relevantDate): ?>
                                                <br><small style="color: #0066cc; font-size: 0.85em; font-weight: bold;">üìÜ <?= htmlspecialchars(date('d/m', strtotime($relevantDate))) ?></small>
                                            <?php endif; ?>
                                        <?php endif; ?>
                                    </td>
                                    <td><?= htmlspecialchars($task['assigned_to'] ?: 'Non assign√©') ?></td>
                                    <td>
                                        <?php if (($task['mode'] ?? 'status') === 'bar'): ?>
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: <?= $displayProgress ?>%"></div>
                                                <span class="progress-text"><?= $displayProgress ?>%</span>
                                            </div>
                                            <?php if ($is_my_task && !$is_done): ?>
                                                <form method="post" action="update_task.php" style="margin-top: 8px;">
                                                    <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                    <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                    <input type="range" name="progress" min="0" max="100" value="<?= $displayProgress ?>" 
                                                           class="progress-slider" onchange="return updateTaskAjax(this.form)" style="width: 100%; cursor: pointer;">
                                                </form>
                                            <?php elseif ($is_my_task && $taskIsCompleted): ?>
                                                <button type="button" class="btn-delete" onclick="return deleteTaskAjax('<?= htmlspecialchars($project['id']) ?>', '<?= htmlspecialchars($task['id']) ?>')" style="margin-top: 8px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">üóëÔ∏è Supprimer</button>
                                            <?php endif; ?>
                                        <?php else: ?>
                                            <?php if ($is_my_task && !$is_done): ?>
                                                <form method="post" action="update_task.php">
                                                    <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
                                                    <input type="hidden" name="task_id" value="<?= htmlspecialchars($task['id']) ?>">
                                                    <select name="status" onchange="return updateTaskAjax(this.form)">
                                                        <option value="todo" <?= $displayStatus === 'todo' ? 'selected' : '' ?>>√Ä faire</option>
                                                        <option value="in_progress" <?= $displayStatus === 'in_progress' ? 'selected' : '' ?>>En cours</option>
                                                        <option value="done" <?= $displayStatus === 'done' ? 'selected' : '' ?>>Termin√©</option>
                                                    </select>
                                                </form>
                                            <?php else: ?>
                                                <?= htmlspecialchars(status_label($displayStatus)) ?>
                                                <?php if ($taskIsCompleted): ?>
                                                    <button type="button" class="btn-delete" onclick="return deleteTaskAjax('<?= htmlspecialchars($project['id']) ?>', '<?= htmlspecialchars($task['id']) ?>')" style="margin-left: 8px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">üóëÔ∏è</button>
                                                <?php endif; ?>
                                            <?php endif; ?>
                                        <?php endif; ?>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </article>
        <?php endforeach; ?>
    <?php endif; ?>
</section>

<?php include __DIR__ . '/includes/footer.php'; ?>

<style>
    .mode-toggle { display: flex; align-items: center; }
    .mode-btn { 
        padding: 6px 12px; 
        margin-right: 6px; 
        background: #f0f0f0; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 0.9rem;
    }
    .mode-btn.active { 
        background: #2d8cff; 
        color: white; 
        border-color: #2d8cff; 
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apply task mode display logic to all task rows
    // Each row has data-task-mode="status" or "bar"
    // - For status mode: show task-status-cell, hide task-progress-cell
    // - For bar mode: show task-progress-cell, hide task-status-cell
    // This is done via CSS rules, but we ensure row elements are properly set
});

window.toggleTasksView = function(projectId) {
    // Get both table wrappers
    const myTasksWrapper = document.querySelector('.table-wrapper[data-project="' + projectId + '"][data-table="mine"]');
    const allTasksWrapper = document.querySelector('.table-wrapper[data-project="' + projectId + '"][data-table="all"]');
    const myTasksBtn = document.querySelector('.btn-toggle[data-project="' + projectId + '"][data-view="mine"]');
    const allTasksBtn = document.querySelector('.btn-toggle[data-project="' + projectId + '"][data-view="all"]');
    
    if (!myTasksWrapper || !allTasksWrapper) return;
    
    // Check current state of myTasks wrapper
    if (myTasksWrapper.style.display === 'none') {
        // Currently showing all, switch to mine
        myTasksWrapper.style.display = '';
        allTasksWrapper.style.display = 'none';
        if (myTasksBtn) myTasksBtn.classList.add('active');
        if (allTasksBtn) allTasksBtn.classList.remove('active');
    } else {
        // Currently showing mine, switch to all
        myTasksWrapper.style.display = 'none';
        allTasksWrapper.style.display = '';
        if (myTasksBtn) myTasksBtn.classList.remove('active');
        if (allTasksBtn) allTasksBtn.classList.add('active');
    }
};
</script>









'day_view.php'
<?php
$page_title = 'Vue jour d√©taill√©e';
require_once __DIR__ . '/includes/functions.php';
require_login();

$user = current_user();
$email = strtolower($user['email']);

$projects = get_full_user_projects($user['id']);

// Get selected date or use today
$selectedDateStr = $_GET['date'] ?? date('Y-m-d');
try {
    $selectedDate = new DateTime($selectedDateStr);
} catch (Exception $e) {
    $selectedDate = new DateTime('today');
}

$today = new DateTime('today');
$dayOfWeek = (int)$selectedDate->format('N');
$dayShorts = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
$shortDay = $dayShorts[$dayOfWeek - 1] ?? 'N/A';

$dayToRecurring = [
    1 => 'mon', 2 => 'tue', 3 => 'wed', 4 => 'thu',
    5 => 'fri', 6 => 'sat', 7 => 'sun'
];
$recurringDay = $dayToRecurring[$dayOfWeek] ?? null;

// Collect all tasks for this day
$tasksForDay = [];
$projectsByTask = [];

foreach ($projects as $project) {
    $isMember = false;
    foreach ($project['members'] as $member) {
        if (strtolower($member['email']) === $email) {
            $isMember = true;
            break;
        }
    }
    
    if (!$isMember) continue;
    
    foreach ($project['tasks'] as $task) {
        if (strtolower($task['assigned_to']) !== $email) continue;
        
        $isForToday = false;
        if ($task['is_recurring'] ?? false) {
            if (in_array($recurringDay, $task['recurring_days'] ?? [])) {
                $isForToday = true;
            }
        }
        
        if ($isForToday) {
            $tasksForDay[] = $task;
            $projectsByTask[$task['id']] = $project;
        }
    }
}

// Calculate detailed statistics
$stats = [
    'total' => count($tasksForDay),
    'done' => 0,
    'in_progress' => 0,
    'todo' => 0,
    'bar_tasks' => 0,
    'status_tasks' => 0,
    'avg_progress' => 0,
    'total_progress' => 0,
];

$selectedDateStr = $selectedDate->format('Y-m-d');

foreach ($tasksForDay as $task) {
    $isBarMode = ($task['mode'] ?? 'status') === 'bar';
    
    if ($isBarMode) {
        $stats['bar_tasks']++;
        // For recurring tasks, use daily progress; for non-recurring, use global progress
        $dayProgress = ($task['is_recurring'] ?? false) 
            ? get_daily_progress($task, $selectedDateStr)
            : ($task['progress'] ?? 0);
        $stats['total_progress'] += $dayProgress;
    } else {
        $stats['status_tasks']++;
    }
    
    // For recurring tasks, check daily_progress for this specific date
    // For non-recurring tasks, check the global status/progress
    if (($task['is_recurring'] ?? false)) {
        $dailyProgress = get_daily_progress($task, $selectedDateStr);
        if ($dailyProgress >= 100) {
            $stats['done']++;
        } else if ($dailyProgress >= 50) {
            $stats['in_progress']++;
        } else {
            $stats['todo']++;
        }
    } else {
        // Non-recurring task: count by global status
        $stats[$task['status'] ?? 'todo']++;
    }
}

if ($stats['bar_tasks'] > 0) {
    $stats['avg_progress'] = round($stats['total_progress'] / $stats['bar_tasks']);
}

$completion_percentage = $stats['total'] > 0 ? round(($stats['done'] / $stats['total']) * 100) : 0;
?>

<?php include __DIR__ . '/includes/header.php'; ?>

<section style="padding: 20px; max-width: 1000px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>üìÜ D√©tail du jour</h1>
        <a href="weekly_view.php" class="btn-secondary" style="display: inline-block; padding: 8px 15px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px;">‚Üê Retour Vue semaine</a>
    </div>

    <!-- Date Header -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; text-align: center;">
        <h2 style="margin: 0; font-size: 2em;">
            <?php
            $dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            $months = [1 => 'janvier', 2 => 'f√©vrier', 3 => 'mars', 4 => 'avril', 5 => 'mai', 6 => 'juin', 
                       7 => 'juillet', 8 => 'ao√ªt', 9 => 'septembre', 10 => 'octobre', 11 => 'novembre', 12 => 'd√©cembre'];
            $dayName = $dayNames[$dayOfWeek - 1] ?? 'Jour inconnu';
            $monthName = $months[(int)$selectedDate->format('m')] ?? 'Mois inconnu';
            echo $dayName . ' ' . $selectedDate->format('d') . ' ' . $monthName . ' ' . $selectedDate->format('Y');
            ?>
        </h2>
        <?php if ($selectedDate->format('Y-m-d') === $today->format('Y-m-d')): ?>
            <p style="margin: 10px 0 0 0; font-size: 1.1em; opacity: 0.9;">Aujourd'hui</p>
        <?php endif; ?>
    </div>

    <!-- Key Statistics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 3em; font-weight: bold;"><?= $stats['total'] ?></div>
            <div style="font-size: 1em; opacity: 0.9; margin-top: 5px;">T√¢ches du jour</div>
        </div>

        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 3em; font-weight: bold;"><?= $completion_percentage ?>%</div>
            <div style="font-size: 1em; opacity: 0.9; margin-top: 5px;">Compl√©t√©es (<?= $stats['done'] ?>/<?= $stats['total'] ?>)</div>
        </div>

        <?php if ($stats['bar_tasks'] > 0): ?>
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 3em; font-weight: bold;"><?= $stats['avg_progress'] ?>%</div>
            <div style="font-size: 1em; opacity: 0.9; margin-top: 5px;">Progression moyenne</div>
        </div>
        <?php endif; ?>

        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 3em; font-weight: bold;"><?= $stats['in_progress'] ?></div>
            <div style="font-size: 1em; opacity: 0.9; margin-top: 5px;">En cours</div>
        </div>
    </div>

    <!-- Task Distribution -->
    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
        <h3>Distribution des statuts</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
            <?php
            $statusInfo = [
                'todo' => ['label' => '√Ä faire', 'color' => '#e8f4f8', 'icon' => 'üìã'],
                'in_progress' => ['label' => 'En cours', 'color' => '#fff4e8', 'icon' => '‚öôÔ∏è'],
                'done' => ['label' => 'Termin√©es', 'color' => '#e8f8e8', 'icon' => '‚úì']
            ];
            foreach ($statusInfo as $status => $info):
            ?>
                <div style="background: <?= $info['color'] ?>; padding: 15px; border-radius: 6px; text-align: center; border-left: 4px solid; border-color: <?= $info['color'] ?>;">
                    <div style="font-size: 2em;"><?= $info['icon'] ?></div>
                    <div style="font-size: 2em; font-weight: bold; margin: 10px 0;"><?= $stats[$status] ?></div>
                    <div style="color: #666; font-size: 0.9em;"><?= $info['label'] ?></div>
                </div>
            <?php endforeach; ?>
        </div>
    </div>

    <!-- Tasks List -->
    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px;">
        <h3>T√¢ches d√©taill√©es</h3>
        
        <?php if (empty($tasksForDay)): ?>
            <p style="color: #999; text-align: center; padding: 40px;">
                ‚ú® Aucune t√¢che pr√©vue pour ce jour. Vos t√¢ches hebdomadaires appara√Ætront ici.
            </p>
        <?php else: ?>
            <div style="display: grid; gap: 15px;">
                <?php foreach ($tasksForDay as $task):
                    $project = $projectsByTask[$task['id']] ?? [];
                    $isBarMode = ($task['mode'] ?? 'status') === 'bar';
                    $dateForCheck = ($task['is_recurring'] ?? false) ? $selectedDate->format('Y-m-d') : null;
                    $isComplete = is_task_complete($task, $dateForCheck);
                    
                    // Get daily status for recurring tasks, global status for non-recurring
                    $displayStatus = ($task['is_recurring'] ?? false) 
                        ? get_daily_status($task, $selectedDate->format('Y-m-d'))
                        : ($task['status'] ?? 'todo');
                ?>
                    <div style="background: <?= $isComplete ? '#e8f8e8' : '#f9f9f9' ?>; border-left: 5px solid <?= $isComplete ? '#28a745' : '#007bff' ?>; padding: 15px; border-radius: 6px;" data-task-id="<?= htmlspecialchars($task['id']) ?>" data-date="<?= htmlspecialchars($selectedDate->format('Y-m-d')) ?>">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 8px 0; font-size: 1.1em;"><?= htmlspecialchars($task['title']) ?></h4>
                                <p style="margin: 0; color: #666; font-size: 0.9em;">
                                    <strong>Projet:</strong> <?= htmlspecialchars($project['name'] ?? 'N/A') ?>
                                </p>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">
                                    <strong>Mode:</strong> <?= $isBarMode ? 'Progression' : 'Statut' ?>
                                </p>
                            </div>

                            <div class="task-status-badge" style="background: <?= $isComplete ? '#28a745' : '#007bff' ?>; color: white; padding: 8px 16px; border-radius: 20px; white-space: nowrap; text-align: center;">
                                <strong><?= htmlspecialchars(status_label($displayStatus)) ?></strong>
                            </div>
                        </div>

                        <?php if ($isBarMode): ?>
                            <div style="margin-top: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 0.9em; color: #666;">Progression</span>
                                    <strong class="task-progress-text"><?= get_daily_progress($task, $selectedDate->format('Y-m-d')) ?>%</strong>
                                </div>
                                <div style="background: #ddd; height: 30px; border-radius: 15px; overflow: hidden;">
                                    <div class="task-progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: <?= get_daily_progress($task, $selectedDate->format('Y-m-d')) ?>%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        <?php $progress = get_daily_progress($task, $selectedDate->format('Y-m-d')); if ($progress > 15): ?>
                                            <?= $progress ?>%
                                        <?php endif; ?>
                                    </div>
                                </div>
                            </div>
                        <?php endif; ?>

                        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <?php 
                            $dailyProgress = get_daily_progress($task, $selectedDate->format('Y-m-d'));
                            $isDayComplete = $dailyProgress >= 100;
                            if ($isBarMode && !$isDayComplete): ?>
                                <button type="button" class="btn-increment-day" onclick="updateDailyTaskProgress('<?= htmlspecialchars($project['id']) ?>', '<?= htmlspecialchars($task['id']) ?>', '<?= htmlspecialchars($selectedDate->format('Y-m-d')) ?>', 'increment', 10)" style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">+10%</button>
                                <button type="button" class="btn-complete-day" onclick="updateDailyTaskProgress('<?= htmlspecialchars($project['id']) ?>', '<?= htmlspecialchars($task['id']) ?>', '<?= htmlspecialchars($selectedDate->format('Y-m-d')) ?>', 'complete')" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">‚úì Terminer</button>
                            <?php elseif ($isBarMode && $isDayComplete): ?>
                                <button disabled style="padding: 6px 12px; background: #ccc; color: white; border: none; border-radius: 4px; cursor: not-allowed; font-size: 0.85em;">‚úì Compl√©t√©e (<?= $dailyProgress ?>%)</button>
                            <?php elseif (!$isBarMode && $displayStatus !== 'done'): ?>
                                <?php if ($displayStatus === 'todo'): ?>
                                    <button onclick="updateTaskStatus('<?= htmlspecialchars($project['id'] ?? '') ?>', '<?= htmlspecialchars($task['id']) ?>', 'in_progress', this<?php if ($task['is_recurring'] ?? false): ?>, '<?= htmlspecialchars($selectedDate->format('Y-m-d')) ?>'<?php endif; ?>)" style="padding: 6px 12px; background: #fd7e14; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">‚ñ∂ Commencer</button>
                                <?php endif; ?>
                                <button onclick="updateTaskStatus('<?= htmlspecialchars($project['id'] ?? '') ?>', '<?= htmlspecialchars($task['id']) ?>', 'done', this<?php if ($task['is_recurring'] ?? false): ?>, '<?= htmlspecialchars($selectedDate->format('Y-m-d')) ?>'<?php endif; ?>)" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">‚úì Terminer</button>
                            <?php else: ?>
                                <button disabled style="padding: 6px 12px; background: #ccc; color: white; border: none; border-radius: 4px; cursor: not-allowed; font-size: 0.85em;">‚úì Compl√©t√©e</button>
                            <?php endif; ?>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>
    </div>

    <!-- Navigation -->
    <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
        <?php
        $prevDate = (clone $selectedDate)->modify('-1 day');
        $nextDate = (clone $selectedDate)->modify('+1 day');
        ?>
        <a href="day_view.php?date=<?= $prevDate->format('Y-m-d') ?>" class="btn-secondary" style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px;">‚Üê Jour pr√©c√©dent</a>
        <a href="day_view.php" class="btn-secondary" style="padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">Aujourd'hui</a>
        <a href="day_view.php?date=<?= $nextDate->format('Y-m-d') ?>" class="btn-secondary" style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px;">Jour suivant ‚Üí</a>
    </div>
</section>

<?php include __DIR__ . '/includes/footer.php'; ?>

<script src="assets/app.js"></script>









'delete_project.php'
<?php
require_once __DIR__ . '/includes/functions.php';
require_login();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: dashboard.php');
    exit;
}

$project_id = $_POST['project_id'] ?? '';
$user = current_user();

if (!$project_id) {
    $_SESSION['error'] = "Projet introuvable.";
    header('Location: dashboard.php');
    exit;
}

try {
    $stmt = $pdo->prepare("DELETE FROM projects WHERE id = ? AND created_by = ?");
    $stmt->execute([$project_id, $user['id']]);

    if ($stmt->rowCount() > 0) {
        log_activity($user['id'], 'delete_project', "project_$project_id", "Projet supprim√©");
        $_SESSION['success'] = "Le projet a √©t√© supprim√© avec succ√®s.";
    } else {
        $_SESSION['error'] = "Impossible de supprimer ce projet (vous n'√™tes peut-√™tre pas le cr√©ateur).";
    }

} catch (Exception $e) {
    $_SESSION['error'] = "Erreur technique : " . $e->getMessage();
}
header('Location: dashboard.php');
exit;








'delete_task.php'
<?php
require_once __DIR__ . '/includes/functions.php';
require_login();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: dashboard.php');
    exit;
}

$project_id = $_POST['project_id'] ?? null;
$task_id    = $_POST['task_id'] ?? null;
$user = current_user();

$is_ajax = isset($_SERVER['HTTP_X_REQUESTED_WITH'])
    && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest';

function sendResponse(bool $success, string $msg)
{
    global $is_ajax;
    
    if ($is_ajax) {
        header('Content-Type: application/json');
        echo json_encode([
            'success' => $success,
            'message' => $msg
        ]);
        exit;
    }

    if ($success) {
        $_SESSION['success'] = $msg;
    } else {
        $_SESSION['error'] = $msg;
    }
    header('Location: dashboard.php');
    exit;
}

if (!$project_id || !$task_id) {
    sendResponse(false, "Param√®tres manquants.");
}

try {
    $stmt = $pdo->prepare("
        SELECT 1 
        FROM projects p 
        LEFT JOIN participants part ON p.id = part.project_id 
        WHERE p.id = ? AND (p.created_by = ? OR part.user_id = ?)
        LIMIT 1
    ");
    $stmt->execute([$project_id, $user['id'], $user['id']]);
    
    if (!$stmt->fetch()) {
        sendResponse(false, "Vous n'avez pas la permission de supprimer cette t√¢che.");
    }

    $stmt = $pdo->prepare("DELETE FROM tasks WHERE id = ? AND project_id = ?");
    $stmt->execute([$task_id, $project_id]);

    if ($stmt->rowCount() > 0) {
        log_activity($user['id'], 'delete_task', "task_$task_id", "T√¢che supprim√©e");
        sendResponse(true, "T√¢che supprim√©e avec succ√®s.");
    } else {
        sendResponse(false, "T√¢che introuvable ou d√©j√† supprim√©e.");
    }

} catch (Exception $e) {
    sendResponse(false, "Erreur de base de donn√©es.");
}
?>








'get_task_daily_progress.php'
<?php
require_once __DIR__ . '/includes/functions.php';
require_login();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(400);
    exit;
}

$project_id = $_POST['project_id'] ?? null;
$task_id = $_POST['task_id'] ?? null;
$date = $_POST['date'] ?? null;

if (!$project_id || !$task_id || !$date) {
    header('Content-Type: application/json');
    echo json_encode(['success' => false, 'error' => 'Missing parameters']);
    exit;
}

try {
    $stmt = $pdo->prepare("SELECT * FROM tasks WHERE id = ? AND project_id = ?");
    $stmt->execute([$task_id, $project_id]);
    $row = $stmt->fetch();

    if (!$row) {
        header('Content-Type: application/json');
        echo json_encode(['success' => false, 'error' => 'Task not found']);
        exit;
    }

    $task = [
        'id' => $row['id'],
        'mode' => $row['mode'],
        'status' => $row['status'],
        'is_recurring' => (bool)$row['is_recurring'],
        'recurring_days' => json_decode($row['recurring_days'] ?? '[]', true),
        'daily_progress' => json_decode($row['daily_progress'] ?? '[]', true),
        'daily_status' => json_decode($row['daily_status'] ?? '[]', true)
    ];
    
    // Get the daily progress for this date
    $dailyProgress = get_daily_progress($task, $date);

    // Determine the status
    $status = 'todo';
    if (($task['mode'] ?? 'status') === 'bar') {
        // For bar mode, we only care about progress
        $status = null;
    } else {
        // For status mode, get the stored status or convert from progress
        if (($task['is_recurring'] ?? false)) {
            // Check if we have a stored status in daily_status
            $dailyStatus = $task['daily_status'] ?? [];
            if (isset($dailyStatus[$date])) {
                $status = $dailyStatus[$date];
            } else {
                // Fallback: convert progress to status
                if ($dailyProgress >= 100) {
                    $status = 'done';
                } else if ($dailyProgress >= 50) {
                    $status = 'in_progress';
                } else {
                    $status = 'todo';
                }
            }
        } else {
            // Non-recurring task: use global status
            $status = $task['status'] ?? 'todo';
        }
    }

    header('Content-Type: application/json');
    echo json_encode([
        'success' => true,
        'progress' => $dailyProgress,
        'status' => $status,
        'date' => $date,
        'mode' => $task['mode'] ?? 'status'
    ]);

} catch (Exception $e) {
    header('Content-Type: application/json');
    echo json_encode(['success' => false, 'error' => 'Database error']);
}
exit;









'index.php'
<?php
$page_title = 'Connexion';
require_once __DIR__ . '/includes/functions.php';

$errors = [];
$success_message = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $action = $_POST['action'] ?? '';

    if ($action === 'login') {
        $email = $_POST['email'] ?? '';
        $password = $_POST['password'] ?? '';

        if (!$email || !$password) {
            $errors[] = 'Veuillez remplir tous les champs de connexion.';
        } else {
            $user = authenticate($email, $password);
            if ($user) {
                login_user($user);
                header('Location: dashboard.php');
                exit;
            } else {
                $errors[] = 'Email ou mot de passe incorrect.';
            }
        }
    } elseif ($action === 'register') {
        $name = $_POST['name'] ?? '';
        $email = $_POST['email'] ?? '';
        $password = $_POST['password'] ?? '';
        $password_confirm = $_POST['password_confirm'] ?? '';

        if (!$name || !$email || !$password || !$password_confirm) {
            $errors[] = 'Veuillez remplir tous les champs d‚Äôinscription.';
        } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            $errors[] = 'Email invalide.';
        } elseif ($password !== $password_confirm) {
            $errors[] = 'Les deux mots de passe ne correspondent pas.';
        } elseif (strlen($password) < 6) {
            $errors[] = 'Le mot de passe doit contenir au moins 6 caract√®res.';
        } else {
            try {
                $user = create_user($name, $email, $password);
                $success_message = "Compte cr√©√© avec succ√®s. Vous pouvez maintenant vous connecter.";
            } catch (Exception $e) {
                $errors[] = $e->getMessage();
            }
        }
    }
}
?>

<?php include __DIR__ . '/includes/header.php'; ?>

<div class="auth-wrapper">
    <div class="auth-card">
        <h1>Connexion</h1>

        <?php if ($errors): ?>
            <div class="alert alert-error">
                <ul>
                    <?php foreach ($errors as $err): ?>
                        <li><?= htmlspecialchars($err) ?></li>
                    <?php endforeach; ?>
                </ul>
            </div>
        <?php endif; ?>

        <?php if ($success_message): ?>
            <div class="alert alert-success">
                <?= htmlspecialchars($success_message) ?>
            </div>
        <?php endif; ?>

        <form method="post" class="form-block">
            <input type="hidden" name="action" value="login">
            <div class="form-group">
                <label for="login_email">Email</label>
                <input type="email" id="login_email" name="email" required>
            </div>
            <div class="form-group">
                <label for="login_password">Mot de passe</label>
                <input type="password" id="login_password" name="password" required>
            </div>
            <button type="submit" class="btn-primary">Se connecter</button>
        </form>
    </div>

    <div class="auth-card">
        <h2>Cr√©er un compte</h2>
        <form method="post" class="form-block">
            <input type="hidden" name="action" value="register">
            <div class="form-group">
                <label for="reg_name">Nom</label>
                <input type="text" id="reg_name" name="name" required>
            </div>
            <div class="form-group">
                <label for="reg_email">Email</label>
                <input type="email" id="reg_email" name="email" required>
            </div>
            <div class="form-group">
                <label for="reg_password">Mot de passe</label>
                <input type="password" id="reg_password" name="password" required>
            </div>
            <div class="form-group">
                <label for="reg_password_confirm">Confirmer le mot de passe</label>
                <input type="password" id="reg_password_confirm" name="password_confirm" required>
            </div>
            <button type="submit" class="btn-secondary">Cr√©er un compte</button>
        </form>
    </div>
</div>

<?php include __DIR__ . '/includes/footer.php'; ?>







'logout.php'
<?php
require_once __DIR__ . '/includes/config.php';

session_unset();
session_destroy();

header('Location: index.php');
exit;






'modify_project.php'
<?php
$page_title = 'Modifier un projet';
require_once __DIR__ . '/includes/functions.php';
require_login();

$user = current_user();
$project_id = $_GET['id'] ?? null;

if (!$project_id) {
    $_SESSION['error'] = "ID du projet manquant.";
    header('Location: dashboard.php');
    exit;
}

try {
    // On r√©cup√®re les infos du projet
    $stmt = $pdo->prepare("SELECT p.*, u.email as creator_email, u.nom as creator_name 
                           FROM projects p 
                           JOIN users u ON p.created_by = u.id 
                           WHERE p.id = ?");
    $stmt->execute([$project_id]);
    $project = $stmt->fetch();

    if (!$project) {
        $_SESSION['error'] = "Projet introuvable.";
        header('Location: dashboard.php');
        exit;
    }

    // On renomme 'nom' en 'name' pour compatibilit√© avec le html
    $project['name'] = $project['nom'];

    // On r√©cup√®re les membres
    $stmt = $pdo->prepare("SELECT u.nom as name, u.email 
                           FROM participants part 
                           JOIN users u ON part.user_id = u.id 
                           WHERE part.project_id = ?");
    $stmt->execute([$project_id]);
    $members = $stmt->fetchAll();
    
    $creatorInList = false;
    foreach($members as $m) {
        if ($m['email'] === $project['creator_email']) $creatorInList = true;
    }
    if (!$creatorInList) {
        array_unshift($members, ['name' => $project['creator_name'], 'email' => $project['creator_email']]);
    }
    $project['members'] = $members;

    // On v√©rifie les droits (le user est-il membre ?)
    $is_member = false;
    $user_email = strtolower($user['email']);
    foreach ($project['members'] as $member) {
        if (strtolower($member['email']) === $user_email) {
            $is_member = true;
            break;
        }
    }

    if (!$is_member) {
        $_SESSION['error'] = "Vous n'avez pas la permission de modifier ce projet.";
        header('Location: dashboard.php');
        exit;
    }

    // On r√©cup√®re les taches
    $stmt = $pdo->prepare("SELECT t.*, u.email as assigned_email 
                           FROM tasks t 
                           LEFT JOIN users u ON t.assigned_to = u.id 
                           WHERE t.project_id = ? 
                           ORDER BY t.id ASC");
    $stmt->execute([$project_id]);
    $dbTasks = $stmt->fetchAll();

    $tasks = [];
    foreach ($dbTasks as $t) {
        $tasks[] = [
            'id' => $t['id'],
            'title' => $t['titre'],
            'assigned_to' => $t['assigned_email'] ?? '', // Pour le select
            'mode' => $t['mode'],
            'is_recurring' => (bool)$t['is_recurring'],
            'recurring_days' => json_decode($t['recurring_days'] ?? '[]', true)
        ];
    }
    $project['tasks'] = $tasks;

    $is_creator = ($project['created_by'] == $user['id']);

} catch (Exception $e) {
    $_SESSION['error'] = "Erreur de base de donn√©es.";
    header('Location: dashboard.php');
    exit;
}
?>

<?php include __DIR__ . '/includes/header.php'; ?>

<section class="form-page">
    <h1>Modifier le projet : <?= htmlspecialchars($project['name']) ?></h1>
    <p>Modifiez les informations, les membres et les t√¢ches du projet.</p>

    <form method="post" action="update_project.php" class="form-block">
        <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">

        <div class="form-group">
            <label for="project_name">Nom du projet</label>
            <input type="text" id="project_name" name="project_name" value="<?= htmlspecialchars($project['name']) ?>" required>
        </div>

        <div class="form-group">
            <label for="project_description">Description (facultatif)</label>
            <textarea id="project_description" name="project_description" rows="3"
                placeholder="Ex : Organisation des t√¢ches m√©nag√®res de l'appartement..."><?= htmlspecialchars($project['description'] ?? '') ?></textarea>
        </div>

        <h2>Membres du projet</h2>
        <p class="hint">
            G√©rez les membres du projet<?php if ($is_creator): ?>. Vous √™tes le cr√©ateur et ne pouvez pas √™tre supprim√©<?php endif; ?>.
        </p>
        <button type="button" class="btn-secondary invite-link-btn" onclick="toggleInviteLink()">
            Afficher le lien d'invitation
        </button>
        <div id="invite-link-box" class="invite-link-box" style="display: none;">
            <p>Partagez ce lien avec les membres que vous avez ajout√©s&nbsp;:</p>
            <code id="invite-link-code" style="cursor: pointer; padding: 8px 12px; background: #f5f5f5; display: inline-block; border-radius: 4px; border: 1px solid #ddd; user-select: all; transition: all 0.2s;" onmouseover="this.style.background='#e8e8e8'; this.style.borderColor='#999';" onmouseout="this.style.background='#f5f5f5'; this.style.borderColor='#ddd';" onclick="copyInviteLink(this)">https://weshare.alwaysdata.net/?project_id=<?= htmlspecialchars($project_id) ?></code>
            <p id="copy-feedback" style="display: none; color: #4caf50; font-weight: bold; margin-top: 8px;">‚úì Lien copi√© !</p>
            <p class="hint">
                Cliquez sur le lien pour le copier, puis envoyez-le √† vos colocataires / camarades / amis.
                Ils pourront cr√©er un compte ou se connecter, puis voir ce projet dans leur tableau de bord.
            </p>
        </div>

        <div id="members-container">
            <?php foreach ($project['members'] as $member): ?>
                <div class="member-row">
                    <input type="text" name="member_name[]" placeholder="Nom du membre" value="<?= htmlspecialchars($member['name']) ?>">
                    <input type="email" name="member_email[]" placeholder="Email du membre" value="<?= htmlspecialchars($member['email']) ?>">
                    <?php if (strtolower($member['email']) !== strtolower($project['creator_email'])): ?>
                        <button type="button" class="btn-secondary btn-remove" onclick="removeMemberRow(this)">‚úï Supprimer</button>
                    <?php else: ?>
                        <span class="badge badge-creator">Cr√©ateur</span>
                    <?php endif; ?>
                </div>
            <?php endforeach; ?>
        </div>
        <button type="button" class="btn-secondary" onclick="addMemberRow()">+ Ajouter un membre</button>


        <h2>T√¢ches du projet</h2>
        <p class="hint">
            Cr√©ez, modifiez ou supprimez les t√¢ches du projet.
        </p>

        <div id="tasks-container">
            <?php foreach ($project['tasks'] as $taskIndex => $task): ?>
                <div class="task-row">
                    <input type="text" name="task_title[]" placeholder="Titre de la t√¢che" value="<?= htmlspecialchars($task['title']) ?>">
                    <select name="task_assigned_to[]">
                        <option value="">-- Non assign√© --</option>
                        <?php foreach ($project['members'] as $member): ?>
                            <option value="<?= htmlspecialchars($member['email']) ?>" <?= strtolower($task['assigned_to'] ?? '') === strtolower($member['email']) ? 'selected' : '' ?>>
                                <?= htmlspecialchars($member['name']) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <select name="task_mode[]" class="task-mode-select" title="Mode d'√©valuation">
                        <option value="status" <?= ($task['mode'] ?? 'status') === 'status' ? 'selected' : '' ?>>Statut</option>
                        <option value="bar" <?= ($task['mode'] ?? 'status') === 'bar' ? 'selected' : '' ?>>Barre</option>
                    </select>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="checkbox" name="task_recurring[]" class="task-recurring-check" <?= ($task['is_recurring'] ?? false) ? 'checked' : '' ?> onchange="toggleRecurringDays(this)">
                        <span>Hebdomadaire</span>
                    </label>
                    <input type="hidden" name="task_id[]" value="<?= htmlspecialchars($task['id']) ?>">
                    <button type="button" class="btn-secondary btn-remove" onclick="removeTaskRow(this)">‚úï Supprimer</button>
                    <?php if ($task['is_recurring'] ?? false): ?>
                        <div class="recurring-days-container" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px; width: 100%;">
                            <?php 
                            $days = [
                                ['label' => 'Lun', 'value' => 'mon'],
                                ['label' => 'Mar', 'value' => 'tue'],
                                ['label' => 'Mer', 'value' => 'wed'],
                                ['label' => 'Jeu', 'value' => 'thu'],
                                ['label' => 'Ven', 'value' => 'fri'],
                                ['label' => 'Sam', 'value' => 'sat'],
                                ['label' => 'Dim', 'value' => 'sun']
                            ];
                            $recurring_days = $task['recurring_days'] ?? [];
                            foreach ($days as $day):
                            ?>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="checkbox" name="task_recurring_days[<?= $taskIndex ?>][]" value="<?= htmlspecialchars($day['value']) ?>" <?= in_array($day['value'], $recurring_days) ? 'checked' : '' ?>>
                                    <span><?= htmlspecialchars($day['label']) ?></span>
                                </label>
                            <?php endforeach; ?>
                        </div>
                    <?php endif; ?>
                </div>
            <?php endforeach; ?>
        </div>
        <button type="button" class="btn-secondary" onclick="addTaskRow()">+ Ajouter une t√¢che</button>

        <div class="form-actions">
            <button type="submit" class="btn-primary">Enregistrer les modifications</button>
            <a href="dashboard.php" class="btn-link">Annuler</a>
        </div>
    </form>

    <?php if ($is_creator): ?>
        <form method="post" action="delete_project.php" style="display:inline; margin-top: 16px;">
            <input type="hidden" name="project_id" value="<?= htmlspecialchars($project['id']) ?>">
            <button type="submit" class="btn-secondary"
                onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer ce projet ?')"
                style="background-color: #e74c3c; color: white;">
                üóëÔ∏è Supprimer le projet
            </button>
        </form>
    <?php endif; ?>
</section>

<?php include __DIR__ . '/includes/footer.php'; ?>






'reactiver_project.php'
<?php
require_once __DIR__ . '/includes/functions.php';
require_login();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: dashboard.php');
    exit;
}

$project_id = $_POST['project_id'] ?? '';
$user = current_user();

if (!$project_id) {
    header('Location: dashboard.php');
    exit;
}

try {
    $stmt = $pdo->prepare("UPDATE projects SET status = 'active' WHERE id = ? AND created_by = ?");
    $stmt->execute([$project_id, $user['id']]);

    if ($stmt->rowCount() > 0) {
        log_activity($user['id'], 'reactivate_project', "project_$project_id", "Projet r√©activ√©");
    }

} catch (Exception $e) {
    // Silencieux en cas d'erreur
}

header('Location: dashboard.php');
exit;







'save_project.php'
<?php
require_once __DIR__ . '/includes/functions.php';
require_login();

$user = current_user();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: create_project.php');
    exit;
}

$name = trim($_POST['project_name'] ?? '');
$description = trim($_POST['project_description'] ?? '');

if ($name === '') {
    $_SESSION['error'] = "Le nom du projet est obligatoire.";
    header('Location: create_project.php');
    exit;
}

try {
    $pdo->beginTransaction();

    $stmt = $pdo->prepare("INSERT INTO projects (nom, description, created_by, status) VALUES (?, ?, ?, 'active')");
    $stmt->execute([$name, $description, $user['id']]);
    $project_id = $pdo->lastInsertId();

    $member_names = $_POST['member_name'] ?? [];
    $member_emails = $_POST['member_email'] ?? [];

    $stmt = $pdo->prepare("INSERT INTO participants (project_id, user_id) VALUES (?, ?)");
    $stmt->execute([$project_id, $user['id']]);

    for ($i = 0; $i < count($member_emails); $i++) {
        $m_email = strtolower(trim($member_emails[$i] ?? ''));
        $m_name = trim($member_names[$i] ?? '');

        if ($m_email === '' || !filter_var($m_email, FILTER_VALIDATE_EMAIL)) continue;
        if ($m_email === strtolower($user['email'])) continue;

        $existing = find_user_by_email($m_email);
        $member_id = null;

        if ($existing) {
            $member_id = $existing['id'];
        } else {
            // On cr√©e un compte invit√©
            $new_user = create_user($m_name ?: explode('@', $m_email)[0], $m_email, 'weshare_invite');
            $member_id = $new_user['id'];
        }

        // On v√©rif doublon avant insertion
        $check = $pdo->prepare("SELECT id FROM participants WHERE project_id = ? AND user_id = ?");
        $check->execute([$project_id, $member_id]);
        if (!$check->fetch()) {
            $stmt->execute([$project_id, $member_id]);
        }
    }

    $task_titles = $_POST['task_title'] ?? [];
    $task_assigned_to = $_POST['task_assigned_to'] ?? [];
    $task_modes = $_POST['task_mode'] ?? [];
    $task_recurring = $_POST['task_recurring'] ?? [];
    $task_recurring_days = $_POST['task_recurring_days'] ?? [];

    // On pr√©pare l'insertion
    $sqlTask = "INSERT INTO tasks (project_id, titre, assigned_to, status, progress, mode, is_recurring, recurring_days, daily_progress, daily_status) 
                VALUES (?, ?, ?, 'todo', 0, ?, ?, ?, '{}', '{}')";
    $stmtTask = $pdo->prepare($sqlTask);

    for ($i = 0; $i < count($task_titles); $i++) {
        $title = trim($task_titles[$i] ?? '');
        if ($title === '') continue;

        $assigned_email = strtolower(trim($task_assigned_to[$i] ?? ''));
        $mode = trim($task_modes[$i] ?? 'status');
        if ($mode !== 'bar') $mode = 'status';

        $is_rec = isset($task_recurring[$i]) && $task_recurring[$i] === 'on' ? 1 : 0;
        
        // Encodage JSON des jours (tableau php -> texte JSON pour la bdd)
        $rec_days_json = '[]';
        if ($is_rec && isset($task_recurring_days[$i]) && is_array($task_recurring_days[$i])) {
            $rec_days_json = json_encode($task_recurring_days[$i]);
        }

        // Pour trouver l'id via l'email
        $assigned_id = null;
        if ($assigned_email) {
            $u = find_user_by_email($assigned_email);
            if ($u) $assigned_id = $u['id'];
        }

        $stmtTask->execute([$project_id, $title, $assigned_id, $mode, $is_rec, $rec_days_json]);
    }

    $pdo->commit();
    log_activity($user['id'], 'create_project', 'project', "Projet $project_id cr√©√©");
    
    header('Location: dashboard.php');
    exit;

} catch (Exception $e) {
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }
    die("Erreur lors de la sauvegarde : " . $e->getMessage());
}
?>







'stats_view.php'
<?php
$page_title = 'Statistiques hebdomadaires';
require_once __DIR__ . '/includes/functions.php';
require_login();

$user = current_user();
$email = strtolower($user['email']);

$projects = get_full_user_projects($user['id']);

// Get today and calculate week
$today = new DateTime('today');
$weekStart = (clone $today)->modify('-' . ($today->format('N') - 1) . ' days'); // Monday of this week
$weekEnd = (clone $weekStart)->modify('+6 days'); // Sunday

// Collect all tasks for the week
$weekTasks = [];
$dailyBreakdown = [];

// Initialize daily breakdown
for ($i = 0; $i < 7; $i++) {
    $date = (clone $weekStart)->modify("+$i days");
    $dateStr = $date->format('Y-m-d');
    $dailyBreakdown[$dateStr] = [
        'total' => 0,
        'done' => 0,
        'in_progress' => 0,
        'todo' => 0,
        'avg_progress' => 0,
        'day_name' => $date->format('l')
    ];
}

$dayToRecurring = [
    1 => 'mon', 2 => 'tue', 3 => 'wed', 4 => 'thu',
    5 => 'fri', 6 => 'sat', 7 => 'sun'
];

foreach ($projects as $project) {
    $isMember = false;
    foreach ($project['members'] as $member) {
        if (strtolower($member['email']) === $email) {
            $isMember = true;
            break;
        }
    }
    
    if (!$isMember) continue;
    
    foreach ($project['tasks'] as $task) {
        if (strtolower($task['assigned_to']) !== $email) continue;
        if (!($task['is_recurring'] ?? false)) continue;
        
        // Add this task to each day it's recurring
        for ($i = 0; $i < 7; $i++) {
            $date = (clone $weekStart)->modify("+$i days");
            $dayOfWeek = (int)$date->format('N');
            $recurringDay = $dayToRecurring[$dayOfWeek] ?? null;
            $dateStr = $date->format('Y-m-d');
            
            if (in_array($recurringDay, $task['recurring_days'] ?? [])) {
                $dailyBreakdown[$dateStr]['total']++;
                
                // Get daily progress for this task on this specific date
                $dailyProgress = get_daily_progress($task, $dateStr);
                
                // Check if complete for this specific day/date
                if ($dailyProgress >= 100) {
                    $dailyBreakdown[$dateStr]['done']++;
                } else if ($dailyProgress >= 50) {
                    $dailyBreakdown[$dateStr]['in_progress']++;
                } else {
                    $dailyBreakdown[$dateStr]['todo']++;
                }
                
                if (($task['mode'] ?? 'status') === 'bar') {
                    $dailyBreakdown[$dateStr]['avg_progress'] += $dailyProgress;
                }
            }
        }
        
        $weekTasks[] = $task;
    }
}

// Calculate week stats
$weekStats = [
    'total' => count($weekTasks),
    'unique_days_with_tasks' => 0,
    'busiest_day' => null,
    'busiest_day_count' => 0,
    'avg_tasks_per_day' => 0,
    'total_completion' => 0,
];

foreach ($dailyBreakdown as $dateStr => $data) {
    if ($data['total'] > 0) {
        $weekStats['unique_days_with_tasks']++;
        if ($data['total'] > $weekStats['busiest_day_count']) {
            $weekStats['busiest_day_count'] = $data['total'];
            $weekStats['busiest_day'] = $dateStr;
        }
    }
    if ($data['total'] > 0 && ($data['avg_progress'] > 0 || $data['done'] > 0)) {
        $progress = $data['total'] > 0 ? round($data['avg_progress'] / max(1, count(array_filter($weekTasks, function($t) use ($data) {
            return ($t['mode'] ?? 'status') === 'bar';
        })))) : 0;
        $weekStats['total_completion'] += $data['done'];
    }
}

if ($weekStats['unique_days_with_tasks'] > 0) {
    $weekStats['avg_tasks_per_day'] = round($weekStats['total'] / 7);
}
?>

<?php include __DIR__ . '/includes/header.php'; ?>

<section style="padding: 20px; max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>üìä Statistiques hebdomadaires</h1>
        <a href="weekly_view.php" class="btn-secondary" style="display: inline-block; padding: 8px 15px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px;">‚Üê Vue semaine</a>
    </div>

    <!-- Week Info -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
        <h2 style="margin: 0; font-size: 1.3em;">Semaine du <?= $weekStart->format('d/m/Y') ?> au <?= $weekEnd->format('d/m/Y') ?></h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">Analyse de votre charge de travail hebdomadaire</p>
    </div>

    <!-- Key Metrics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2.5em; font-weight: bold;"><?= $weekStats['total'] ?></div>
            <div style="font-size: 0.95em; opacity: 0.9; margin-top: 5px;">T√¢ches hebdomadaires</div>
        </div>

        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2.5em; font-weight: bold;"><?= $weekStats['unique_days_with_tasks'] ?></div>
            <div style="font-size: 0.95em; opacity: 0.9; margin-top: 5px;">Jours avec t√¢ches</div>
        </div>

        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2.5em; font-weight: bold;"><?= $weekStats['avg_tasks_per_day'] ?></div>
            <div style="font-size: 0.95em; opacity: 0.9; margin-top: 5px;">Moyenne par jour</div>
        </div>

        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2.5em; font-weight: bold;">
                <?php
                $completedThisWeek = 0;
                foreach ($dailyBreakdown as $data) {
                    $completedThisWeek += $data['done'];
                }
                echo $completedThisWeek;
                ?>
            </div>
            <div style="font-size: 0.95em; opacity: 0.9; margin-top: 5px;">T√¢ches termin√©es</div>
        </div>
    </div>

    <!-- Daily Breakdown Chart -->
    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
        <h3 style="margin-top: 0;">R√©partition par jour</h3>
        <div style="display: grid; gap: 15px;">
            <?php
            $dayNames = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'];
            $dayShorts = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            $idx = 0;
            foreach ($dailyBreakdown as $dateStr => $data):
                $dayName = $dayShorts[$idx] ?? 'N/A';
                $isToday = $dateStr === $today->format('Y-m-d');
                $bgColor = $isToday ? '#e8f4f8' : '#f9f9f9';
                $maxTasks = max(array_map(function($d) { return $d['total']; }, $dailyBreakdown));
                $barWidth = $maxTasks > 0 ? ($data['total'] / $maxTasks) * 100 : 0;
                $idx++;
            ?>
                <div style="background: <?= $bgColor ?>; padding: 15px; border-radius: 6px; border-left: 4px solid <?= $isToday ? '#007bff' : '#ddd' ?>;">
                    <div style="display: grid; grid-template-columns: 80px 1fr auto; gap: 15px; align-items: center;">
                        <div style="font-weight: bold; font-size: 1.1em;"><?= $dayName ?></div>
                        <div>
                            <div style="background: #eee; height: 24px; border-radius: 12px; overflow: hidden; position: relative;">
                                <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: <?= $barWidth ?>%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8em;">
                                    <?php if ($barWidth > 15): ?>
                                        <?= $data['total'] ?> t√¢che<?= $data['total'] > 1 ? 's' : '' ?>
                                    <?php endif; ?>
                                </div>
                                <?php if ($barWidth <= 15 && $data['total'] > 0): ?>
                                    <span style="position: absolute; left: <?= $barWidth + 5 ?>%; top: 50%; transform: translateY(-50%); font-weight: bold; color: #666; font-size: 0.8em;"><?= $data['total'] ?></span>
                                <?php endif; ?>
                            </div>
                        </div>
                        <div style="text-align: right; min-width: 100px;">
                            <div style="font-size: 0.85em; color: #666;">
                                ‚úì <?= $data['done'] ?> | ‚öôÔ∏è <?= $data['in_progress'] ?> | üìã <?= $data['todo'] ?>
                            </div>
                        </div>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>
    </div>

    <!-- Busiest Day Alert -->
    <?php if ($weekStats['busiest_day']): ?>
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h3 style="margin: 0 0 10px 0;">‚ö†Ô∏è Jour le plus charg√©</h3>
            <p style="margin: 0;">
                <?php
                $busiestDate = new DateTime($weekStats['busiest_day']);
                $dayNames = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'];
                $dayName = ucfirst($dayNames[(int)$busiestDate->format('N') - 1]);
                echo $dayName . ' ' . $busiestDate->format('d/m/Y') . ' - ' . $weekStats['busiest_day_count'] . ' t√¢che' . ($weekStats['busiest_day_count'] > 1 ? 's' : '') . ' pr√©vues';
                ?>
            </p>
            <a href="day_view.php?date=<?= $weekStats['busiest_day'] ?>" style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: rgba(255,255,255,0.3); color: white; text-decoration: none; border-radius: 4px; border: 2px solid white;">Voir le d√©tail ‚Üí</a>
        </div>
    <?php endif; ?>

    <!-- Tasks by Project -->
    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
        <h3 style="margin-top: 0;">T√¢ches hebdomadaires par projet</h3>
        <div style="display: grid; gap: 12px;">
            <?php
            $tasksByProject = [];
            foreach ($projects as $project) {
                $isMember = false;
                foreach ($project['members'] as $member) {
                    if (strtolower($member['email']) === $email) {
                        $isMember = true;
                        break;
                    }
                }
                
                if (!$isMember) continue;
                
                $projectTasks = [];
                foreach ($project['tasks'] as $task) {
                    if (strtolower($task['assigned_to']) === $email && ($task['is_recurring'] ?? false)) {
                        $projectTasks[] = $task;
                    }
                }
                
                if (!empty($projectTasks)) {
                    $tasksByProject[$project['name']] = $projectTasks;
                }
            }
            
            if (empty($tasksByProject)):
            ?>
                <p style="color: #999; text-align: center; padding: 20px;">Aucune t√¢che hebdomadaire</p>
            <?php
            else:
                foreach ($tasksByProject as $projectName => $tasks):
            ?>
                <div style="background: #f9f9f9; padding: 12px; border-radius: 6px;">
                    <strong><?= htmlspecialchars($projectName) ?></strong> 
                    <span style="float: right; background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em;"><?= count($tasks) ?> t√¢che<?= count($tasks) > 1 ? 's' : '' ?></span>
                    <div style="clear: both; margin-top: 8px; font-size: 0.9em; color: #666;">
                        <?php foreach ($tasks as $task): ?>
                            <div style="margin: 4px 0;">‚Ä¢ <?= htmlspecialchars($task['title']) ?> 
                                <span style="color: #999;">(<?= htmlspecialchars(format_recurring_days($task['recurring_days'] ?? [])) ?>)</span>
                            </div>
                        <?php endforeach; ?>
                    </div>
                </div>
            <?php
                endforeach;
            endif;
            ?>
        </div>
    </div>

    <!-- Tips Section -->
    <div style="background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); color: #333; padding: 20px; border-radius: 8px;">
        <h3 style="margin-top: 0;">üí° Conseils pour optimiser votre semaine</h3>
        <ul style="margin: 10px 0; padding-left: 20px;">
            <li>R√©partissez vos t√¢ches hebdomadaires pour √©viter les pics de charge</li>
            <li>Utilisez la vue jour pour vous concentrer sur les t√¢ches du jour</li>
            <li>Mettez √† jour r√©guli√®rement votre progression pour une meilleure vue d'ensemble</li>
            <li>Ajustez les jours r√©currents de vos t√¢ches si la charge est in√©gale</li>
        </ul>
    </div>
</section>

<?php include __DIR__ . '/includes/footer.php'; ?>







'update_project.php'
<?php
require_once __DIR__ . '/includes/functions.php';
require_login();

$user = current_user();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: dashboard.php');
    exit;
}

$project_id = $_POST['project_id'] ?? null;
$name = trim($_POST['project_name'] ?? '');
$description = trim($_POST['project_description'] ?? '');

if (!$project_id || $name === '') {
    $_SESSION['error'] = "Le nom du projet est obligatoire.";
    header('Location: modify_project.php?id=' . urlencode($project_id ?? ''));
    exit;
}

try {
    $pdo->beginTransaction();

    // On v√©rifie les droits et l'existence du projet
    $stmt = $pdo->prepare("
        SELECT p.id, p.created_by 
        FROM projects p 
        JOIN participants part ON p.id = part.project_id 
        WHERE p.id = ? AND part.user_id = ?
    ");
    $stmt->execute([$project_id, $user['id']]);
    $project = $stmt->fetch();

    if (!$project) {
        throw new Exception("Projet introuvable ou droits insuffisants.");
    }

    // On met √† jour les infos de base
    $stmt = $pdo->prepare("UPDATE projects SET nom = ?, description = ? WHERE id = ?");
    $stmt->execute([$name, $description, $project_id]);

    // On g√®re les membres (sync)
    $member_emails_input = $_POST['member_email'] ?? [];
    $member_names_input = $_POST['member_name'] ?? [];
    $final_member_ids = [];

    $final_member_ids[] = $project['created_by'];

    for ($i = 0; $i < count($member_emails_input); $i++) {
        $m_email = strtolower(trim($member_emails_input[$i] ?? ''));
        $m_name = trim($member_names_input[$i] ?? '');

        if ($m_email === '' || !filter_var($m_email, FILTER_VALIDATE_EMAIL)) continue;

        // Trouver ou cr√©er l'utilisateur
        $u = find_user_by_email($m_email);
        if ($u) {
            $final_member_ids[] = $u['id'];
        } else {
            $new_user = create_user($m_name ?: explode('@', $m_email)[0], $m_email, 'weshare_invite');
            $final_member_ids[] = $new_user['id'];
        }
    }
    
    $final_member_ids = array_unique($final_member_ids);

    // On supprime les anciens membres qui ne sont plus dans la liste
    $placeholders = implode(',', array_fill(0, count($final_member_ids), '?'));
    $sqlDeleteMembers = "DELETE FROM participants WHERE project_id = ? AND user_id NOT IN ($placeholders)";
    // Puis on fusionne l'ID projet avec les IDs membres pour les param√®tres
    $stmt = $pdo->prepare($sqlDeleteMembers);
    $stmt->execute(array_merge([$project_id], $final_member_ids));

    // On ajoute les nouveaux membres
    $stmtCheck = $pdo->prepare("SELECT id FROM participants WHERE project_id = ? AND user_id = ?");
    
    foreach ($final_member_ids as $uid) {
        $stmtCheck->execute([$project_id, $uid]);
        if (!$stmtCheck->fetch()) {
            $stmtInsert = $pdo->prepare("INSERT INTO participants (project_id, user_id) VALUES (?, ?)");
            $stmtInsert->execute([$project_id, $uid]);
        }
    }


    // On g√®re les taches (sync)
    
    $task_ids_input = $_POST['task_id'] ?? [];
    $task_titles = $_POST['task_title'] ?? [];
    $task_assigned_to = $_POST['task_assigned_to'] ?? [];
    $task_modes = $_POST['task_mode'] ?? [];
    $task_recurring = $_POST['task_recurring'] ?? [];
    $task_recurring_days = $_POST['task_recurring_days'] ?? []; // Tableau √† 2 dimensions

    // On supprime les taches qui ne sont plus dans le formulaire
    $valid_task_ids = array_filter($task_ids_input); // Enl√®ve les vides (nouvelles taches)
    
    if (!empty($valid_task_ids)) {
        $placeholders = implode(',', array_fill(0, count($valid_task_ids), '?'));
        $sqlDeleteTasks = "DELETE FROM tasks WHERE project_id = ? AND id NOT IN ($placeholders)";
        $stmt = $pdo->prepare($sqlDeleteTasks);
        $stmt->execute(array_merge([$project_id], $valid_task_ids));
    } else {
        if (count($task_titles) > 0) {
             $pdo->prepare("DELETE FROM tasks WHERE project_id = ?")->execute([$project_id]);
        }
        if (empty($task_titles)) {
             $pdo->prepare("DELETE FROM tasks WHERE project_id = ?")->execute([$project_id]);
        }
    }


    // On met √† jour ou cr√©e les taches
    $stmtUpdate = $pdo->prepare("UPDATE tasks SET titre=?, assigned_to=?, mode=?, is_recurring=?, recurring_days=? WHERE id=? AND project_id=?");
    $stmtInsert = $pdo->prepare("INSERT INTO tasks (project_id, titre, assigned_to, status, progress, mode, is_recurring, recurring_days, daily_progress, daily_status) VALUES (?, ?, ?, 'todo', 0, ?, ?, ?, '{}', '{}')");

    for ($i = 0; $i < count($task_titles); $i++) {
        $t_title = trim($task_titles[$i] ?? '');
        if ($t_title === '') continue;

        $t_id = $task_ids_input[$i] ?? '';
        $t_assigned_email = strtolower(trim($task_assigned_to[$i] ?? ''));
        $t_mode = ($task_modes[$i] ?? 'status') === 'bar' ? 'bar' : 'status';
        
        $t_is_rec = isset($task_recurring[$i]) ? 1 : 0; 
        
        $t_rec_days_json = '[]';
        if ($t_is_rec && isset($task_recurring_days[$i])) {
            $t_rec_days_json = json_encode($task_recurring_days[$i]);
        }

        // Trouver id assign√©
        $t_assigned_id = null;
        if ($t_assigned_email) {
            $u = find_user_by_email($t_assigned_email);
            if ($u) $t_assigned_id = $u['id'];
        }

        if ($t_id) {
            // Mise √† jour
            $stmtUpdate->execute([$t_title, $t_assigned_id, $t_mode, $t_is_rec, $t_rec_days_json, $t_id, $project_id]);
        } else {
            // Cr√©ation
            $stmtInsert->execute([$project_id, $t_title, $t_assigned_id, $t_mode, $t_is_rec, $t_rec_days_json]);
        }
    }

    $pdo->commit();
    $_SESSION['success'] = "Le projet a √©t√© modifi√© avec succ√®s.";
    header('Location: dashboard.php');
    exit;

} catch (Exception $e) {
    if ($pdo->inTransaction()) {
        $pdo->rollBack();
    }
    $_SESSION['error'] = "Erreur lors de la mise √† jour : " . $e->getMessage();
    header('Location: modify_project.php?id=' . urlencode($project_id));
    exit;
}








'update_task.php'
<?php
require_once __DIR__ . '/includes/functions.php';
require_login();

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: dashboard.php');
    exit;
}

$task_id    = $_POST['task_id'] ?? null;
$status     = $_POST['status'] ?? null;
$progress   = $_POST['progress'] ?? null;
$dateOrDay  = $_POST['date'] ?? null;  // For recurring tasks, the specific date/day

if (!$task_id) {
    sendResponse(false, "Param√®tres manquants.");
}

$allowed_status = ['todo', 'in_progress', 'done'];

try {
    // On r√©cup√®re la t√¢che (sql)
    $stmt = $pdo->prepare("SELECT * FROM tasks WHERE id = ?");
    $stmt->execute([$task_id]);
    $row = $stmt->fetch();

    if (!$row) {
        sendResponse(false, "T√¢che introuvable.");
    }

    // On d√©code les colonnes texte pour manipuler des tableaux
    $task = [
        'id' => $row['id'],
        'status' => $row['status'],
        'progress' => (int)$row['progress'],
        'mode' => $row['mode'],
        'is_recurring' => (bool)$row['is_recurring'],
        'daily_progress' => json_decode($row['daily_progress'] ?? '[]', true),
        'daily_status' => json_decode($row['daily_status'] ?? '[]', true)
    ];

    $changed = false;

    // Update status
    if ($status !== null) {
        if (!in_array($status, $allowed_status, true)) sendResponse(false, "Statut invalide.");
        
        if ($task['is_recurring'] && $dateOrDay) {
            if ($task['mode'] === 'bar') {
                $statusValue = ($status === 'done') ? 100 : (($status === 'in_progress') ? 50 : 0);
                set_daily_progress($task, $dateOrDay, $statusValue);
            } else {
                if (!isset($task['daily_status'])) $task['daily_status'] = [];
                $task['daily_status'][$dateOrDay] = $status;
            }
        } else {
            $task['status'] = $status;
        }
        $changed = true;
    }

    // Update progress
    if ($progress !== null) {
        $pv = intval($progress);
        if ($pv < 0 || $pv > 100) sendResponse(false, "Progression invalide.");
        
        if ($task['is_recurring'] && $dateOrDay) {
            set_daily_progress($task, $dateOrDay, $pv);
        } else {
            $task['progress'] = $pv;
        }
        $changed = true;
    }

    if (!$changed) {
        sendResponse(false, "Aucune modification effectu√©e.");
    }

    // On sauvegarde en bdd (encode en JSON)
    $sql = "UPDATE tasks SET status = ?, progress = ?, daily_progress = ?, daily_status = ? WHERE id = ?";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([
        $task['status'],
        $task['progress'],
        json_encode($task['daily_progress']), 
        json_encode($task['daily_status']),
        $task_id
    ]);

    log_activity(current_user()['id'], 'update_task', "task_$task_id", "Status: $status / Progress: $progress");

    if (isset($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest') {
        header('Content-Type: application/json');
        echo json_encode([
            'success' => true,
            'message' => "Mise √† jour r√©ussie.",
            'progress' => intval($_POST['progress'] ?? 0),
            'status' => $_POST['status'] ?? null,
            'date' => $dateOrDay
        ]);
        exit;
    }
    
    sendResponse(true, "Mise √† jour r√©ussie.");

} catch (Exception $e) {
    sendResponse(false, "Erreur serveur : " . $e->getMessage());
}

// -------------------------------------
// Fonction utilitaire de r√©ponse AJAX
// -------------------------------------
function sendResponse(bool $success, string $msg)
{
    $is_ajax = isset($_SERVER['HTTP_X_REQUESTED_WITH'])
        && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) === 'xmlhttprequest';

    if ($is_ajax) {
        header('Content-Type: application/json');
        echo json_encode([
            'success' => $success,
            'message' => $msg
        ]);
        exit;
    }

    header('Location: dashboard.php');
    exit;
}
?>








'update_task_daily.php'
<?php
/**
 * AJAX endpoint to update daily task progress
 * Handles incremental updates (+10%, +25%) and completion
 */
require_once __DIR__ . '/includes/functions.php';
require_login();

$user = current_user();
$email = strtolower($user['email']);

header('Content-Type: application/json');

try {
    $projectId = $_POST['project_id'] ?? null;
    $taskId = $_POST['task_id'] ?? null;
    $dayOrDate = $_POST['day'] ?? null;
    $action = $_POST['action'] ?? null; // 'increment', 'set', 'complete'
    $value = isset($_POST['value']) ? (int)$_POST['value'] : null;
    
    if (!$projectId || !$taskId || !$dayOrDate || !$action) {
        throw new Exception('Missing required parameters');
    }
    
    // On r√©cup√®re la tache en bdd
    $stmt = $pdo->prepare("SELECT * FROM tasks WHERE id = ? AND project_id = ?");
    $stmt->execute([$taskId, $projectId]);
    $row = $stmt->fetch();

    if (!$row) {
        throw new Exception('Task not found');
    }

    // On v√©rifie les permissions (est-ce que le user est assign√© ?)
    if ($row['assigned_to'] != $user['id']) {
        throw new Exception('Task not assigned to you');
    }

    // On reconstruit l'objet tache php avec les JSON d√©cod√©s
    $task = [
        'id' => $row['id'],
        'mode' => $row['mode'],
        'is_recurring' => (bool)$row['is_recurring'],
        'daily_progress' => json_decode($row['daily_progress'] ?? '[]', true),
    ];

    // V√©rif mode
    if ($task['mode'] !== 'bar' || !$task['is_recurring']) {
        throw new Exception('Invalid task type for daily update');
    }

    // Logique de mise √† jour
    $currentProgress = get_daily_progress($task, $dayOrDate);
    $newProgress = $currentProgress;

    switch ($action) {
        case 'increment':
            if ($value === null) throw new Exception('Value required');
            $newProgress = min(100, $currentProgress + $value);
            break;
        case 'set':
            if ($value === null) throw new Exception('Value required');
            $newProgress = max(0, min(100, $value));
            break;
        case 'complete':
            $newProgress = 100;
            break;
        default:
            throw new Exception('Invalid action');
    }

    // Mise √† jour de l'array
    set_daily_progress($task, $dayOrDate, $newProgress);

    // Sauvegarde sql
    $sql = "UPDATE tasks SET daily_progress = ? WHERE id = ?";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([
        json_encode($task['daily_progress']),
        $taskId
    ]);
    
} catch (Exception $e) {
    http_response_code(400);
    echo json_encode([
        'success' => false,
        'error' => $e->getMessage()
    ]);
}








'weekly_view.php'
<?php
$page_title = 'Vue semaine';
require_once __DIR__ . '/includes/functions.php';
require_login();

$user = current_user();
$email = strtolower($user['email']);

$projects = get_full_user_projects($user['id']);

// Get today's date and calculate the range
$today = new DateTime('today');
$dateStart = (new DateTime('today'))->modify('-2 days');
$dateEnd = (new DateTime('today'))->modify('+9 days');

// Get selected date from URL or use today
$selectedDateStr = $_GET['date'] ?? $today->format('Y-m-d');
try {
    $selectedDate = new DateTime($selectedDateStr);
} catch (Exception $e) {
    $selectedDate = $today;
}

// Validate selected date is within range
if ($selectedDate < $dateStart || $selectedDate > $dateEnd) {
    $selectedDate = $today;
}

// Get the day of week (1=Monday, 7=Sunday)
$dayOfWeek = (int)$selectedDate->format('N');
$dayShorts = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
$shortDay = $dayShorts[$dayOfWeek - 1] ?? 'N/A';

// Map numeric day to recurring day values
$dayToRecurring = [
    1 => 'mon', // Monday
    2 => 'tue', // Tuesday
    3 => 'wed', // Wednesday
    4 => 'thu', // Thursday
    5 => 'fri', // Friday
    6 => 'sat', // Saturday
    7 => 'sun'  // Sunday
];
$recurringDay = $dayToRecurring[$dayOfWeek] ?? null;

// Collect all tasks for this day from all projects
$tasksForDay = [];

foreach ($projects as $project) {
    // Check if user is member
    $isMember = false;
    foreach ($project['members'] as $member) {
        if (strtolower($member['email']) === $email) {
            $isMember = true;
            break;
        }
    }
    
    if (!$isMember) {
        continue;
    }
    
    // Filter tasks for this day
    foreach ($project['tasks'] as $task) {
        // Only show tasks assigned to current user
        if (strtolower($task['assigned_to']) !== $email) {
            continue;
        }
        
        // Check if task is for this day
        $isForToday = false;
        
        if ($task['is_recurring'] ?? false) {
            // Check if today's day is in recurring days
            if (in_array($recurringDay, $task['recurring_days'] ?? [])) {
                $isForToday = true;
            }
        }
        
        if ($isForToday) {
            $tasksForDay[] = [
                'task' => $task,
                'project' => $project,
                'projectId' => $project['id']
            ];
        }
    }
}

// Sort tasks by status and completion
usort($tasksForDay, function ($a, $b) {
    $taskA = $a['task'];
    $taskB = $b['task'];
    
    $statusOrder = ['todo' => 0, 'in_progress' => 1, 'done' => 2];
    $orderA = $statusOrder[$taskA['status'] ?? 'todo'] ?? 0;
    $orderB = $statusOrder[$taskB['status'] ?? 'todo'] ?? 0;
    
    return $orderA <=> $orderB;
});

// Calculate statistics - IDENTICAL LOGIC TO stats_view.php
$totalTasks = count($tasksForDay);
$doneTasks = 0;
$totalProgress = 0;
$barTasksCount = 0;

// Build daily breakdown for the selected date to count completed tasks properly
$selectedDateStr = $selectedDate->format('Y-m-d');
$dayOfWeekNum = (int)$selectedDate->format('N');
$dayToRecurring = [
    1 => 'mon', 2 => 'tue', 3 => 'wed', 4 => 'thu',
    5 => 'fri', 6 => 'sat', 7 => 'sun'
];
$selectedDayAbbr = $dayToRecurring[$dayOfWeekNum] ?? null;

foreach ($tasksForDay as $item) {
    $task = $item['task'];
    $isBarMode = ($task['mode'] ?? 'status') === 'bar';
    
    // For recurring tasks, use daily_progress; for non-recurring use global progress
    if ($isBarMode) {
        if ($task['is_recurring'] ?? false) {
            $dailyProgress = get_daily_progress($task, $selectedDateStr);
            $totalProgress += $dailyProgress;
        } else {
            $totalProgress += $task['progress'] ?? 0;
        }
        $barTasksCount++;
    }
    
    // Check if task is complete for this specific date
    // Using is_task_complete with date for recurring tasks
    $dateForCheck = ($task['is_recurring'] ?? false) ? $selectedDateStr : null;
    if (is_task_complete($task, $dateForCheck)) {
        $doneTasks++;
    }
}

$avgProgress = $barTasksCount > 0 ? round($totalProgress / $barTasksCount) : 0;
?>

<?php include __DIR__ . '/includes/header.php'; ?>

<section style="padding: 20px; max-width: 1200px; margin: 0 auto;">
    <h1>üìÖ Vue semaine</h1>
    
    <!-- Current date info -->
    <div style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
        <h2 style="margin: 0; font-size: 1.5em;">
            <?= strtoupper($shortDay) ?> <?= $selectedDate->format('d ') ?>
            <?php 
            $months = [
                1 => 'janvier', 2 => 'f√©vrier', 3 => 'mars', 4 => 'avril',
                5 => 'mai', 6 => 'juin', 7 => 'juillet', 8 => 'ao√ªt',
                9 => 'septembre', 10 => 'octobre', 11 => 'novembre', 12 => 'd√©cembre'
            ];
            echo $months[(int)$selectedDate->format('m')];
            ?>
            <?= $selectedDate->format('Y') ?>
        </h2>
        <?php if ($selectedDate->format('Y-m-d') === $today->format('Y-m-d')): ?>
            <p style="color: #007bff; font-weight: bold;">Aujourd'hui</p>
        <?php endif; ?>
        <div style="margin-top: 10px;">
            <a href="day_view.php?date=<?= $selectedDate->format('Y-m-d') ?>" class="btn-secondary" style="display: inline-block; padding: 8px 16px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">Vue jour d√©taill√©e ‚Üí</a>
        </div>
    </div>

    <!-- Calendar -->
    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <h3>Semaine</h3>
        <div style="display: flex; gap: 8px; overflow-x: auto; padding: 10px 0;">
            <?php
            $current = clone $dateStart;
            while ($current <= $dateEnd) {
                $date = $current->format('Y-m-d');
                $isSelected = $date === $selectedDate->format('Y-m-d');
                $isToday = $date === $today->format('Y-m-d');
                
                $dayNum = $current->format('d');
                $dayName = ['lun', 'mar', 'mer', 'jeu', 'ven', 'sam', 'dim'];
                $dayShort = $dayName[(int)$current->format('N') - 1];
                
                $bgColor = $isSelected ? '#007bff' : ($isToday ? '#e8f4f8' : '#f9f9f9');
                $textColor = $isSelected ? 'white' : 'black';
                $borderColor = $isToday ? '2px solid #007bff' : '1px solid #ddd';
                
                echo '<a href="?date=' . $date . '" style="text-decoration: none; display: flex; flex-direction: column; align-items: center; padding: 10px 15px; background: ' . $bgColor . '; border: ' . $borderColor . '; border-radius: 6px; cursor: pointer; color: ' . $textColor . '; font-weight: ' . ($isToday ? 'bold' : 'normal') . '; min-width: 70px; text-align: center;">';
                echo '<small>' . strtoupper($dayShort) . '</small>';
                echo '<strong style="font-size: 1.2em;">' . $dayNum . '</strong>';
                echo '</a>';
                
                $current->modify('+1 day');
            }
            ?>
        </div>
    </div>

    <!-- Statistics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold;"><?= $totalTasks ?></div>
            <div style="font-size: 0.9em; opacity: 0.9;">T√¢ches du jour</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold;"><?= $doneTasks ?> / <?= $totalTasks ?></div>
            <div style="font-size: 0.9em; opacity: 0.9;">Compl√©t√©es</div>
        </div>
        
        <?php if ($barTasksCount > 0): ?>
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold;"><?= $avgProgress ?>%</div>
            <div style="font-size: 0.9em; opacity: 0.9;">Progression moyenne</div>
        </div>
        <?php endif; ?>
    </div>

    <!-- Tasks for the day -->
    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px;">
        <h3>T√¢ches du <?= strtoupper($shortDay) ?></h3>
        
        <?php if (empty($tasksForDay)): ?>
            <p style="color: #999; text-align: center; padding: 40px 20px;">
                ‚ú® Aucune t√¢che pr√©vue pour ce jour. Profitez-en !
            </p>
        <?php else: ?>
            <div style="display: grid; gap: 15px;">
                <?php foreach ($tasksForDay as $item): 
                    $task = $item['task'];
                    $project = $item['project'];
                    $isBarMode = ($task['mode'] ?? 'status') === 'bar';
                    $dateForCheck = ($task['is_recurring'] ?? false) ? $selectedDate->format('Y-m-d') : null;
                    $isComplete = is_task_complete($task, $dateForCheck);
                    $statusColors = [
                        'todo' => '#e8f4f8',
                        'in_progress' => '#fff4e8',
                        'done' => '#e8f8e8'
                    ];
                    $statusBgColor = $statusColors[$task['status'] ?? 'todo'] ?? '#f9f9f9';
                ?>
                    <div style="background: <?= $isComplete ? '#e8f8e8' : $statusBgColor ?>; border-left: 4px solid <?= $isComplete ? '#4caf50' : '#007bff' ?>; padding: 15px; border-radius: 6px;" data-task-id="<?= htmlspecialchars($task['id']) ?>" data-date="<?= htmlspecialchars($selectedDate->format('Y-m-d')) ?>">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0; font-size: 1.1em;"><?= htmlspecialchars($task['title']) ?></h4>
                                <small style="color: #666;">
                                    Projet: <strong><?= htmlspecialchars($project['name']) ?></strong>
                                </small>
                            </div>
                            <span style="background: <?= $isComplete ? '#4caf50' : '#007bff' ?>; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.85em; white-space: nowrap;">
                                <?php 
                                    $dailyStatus = ($task['is_recurring'] ?? false) ? get_daily_status($task, $selectedDate->format('Y-m-d')) : $task['status'];
                                    echo htmlspecialchars(status_label($dailyStatus));
                                ?>
                            </span>
                        </div>

                        <?php if ($isBarMode): ?>
                            <div style="margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <small style="color: #666;">Progression</small>
                                    <strong class="task-progress-text"><?= get_daily_progress($task, $selectedDate->format('Y-m-d')) ?>%</strong>
                                </div>
                                <div style="background: #ddd; height: 24px; border-radius: 12px; overflow: hidden;">
                                    <div class="task-progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: <?= get_daily_progress($task, $selectedDate->format('Y-m-d')) ?>%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8em; font-weight: bold;">
                                        <?php 
                                        $dailyProgress = get_daily_progress($task, $selectedDate->format('Y-m-d'));
                                        if ($dailyProgress > 10): ?>
                                            <?= $dailyProgress ?>%
                                        <?php endif; ?>
                                    </div>
                                </div>
                            </div>
                        <?php endif; ?>

                        <div style="margin-top: 12px; display: flex; gap: 10px;">
                            <a href="day_view.php?date=<?= $selectedDate->format('Y-m-d') ?>" class="btn-secondary" style="display: inline-block; padding: 6px 12px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9em;">Voir jour</a>
                            <?php 
                            $dailyProgress = get_daily_progress($task, $selectedDate->format('Y-m-d'));
                            $isDayComplete = $dailyProgress >= 100;
                            if ($isBarMode && !$isDayComplete): ?>
                                <button type="button" class="btn-increment-day" onclick="updateDailyTaskProgress('<?= htmlspecialchars($item['projectId']) ?>', '<?= htmlspecialchars($task['id']) ?>', '<?= htmlspecialchars($selectedDate->format('Y-m-d')) ?>', 'increment', 25)" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">+25%</button>
                            <?php elseif ($isBarMode && $isDayComplete): ?>
                                <button disabled style="padding: 6px 12px; background: #ccc; color: white; border: none; border-radius: 4px; cursor: not-allowed; font-size: 0.9em;">‚úì Compl√©t√©e (<?= $dailyProgress ?>%)</button>
                            <?php elseif (!$isBarMode && !$isComplete): ?>
                                <button class="btn-secondary" onclick="updateTaskStatus('<?= htmlspecialchars($item['projectId']) ?>', '<?= htmlspecialchars($task['id']) ?>', 'done', this<?php if ($task['is_recurring'] ?? false): ?>, '<?= htmlspecialchars($selectedDate->format('Y-m-d')) ?>'<?php endif; ?>)" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">‚úì Marquer compl√®te</button>
                            <?php elseif ($isComplete): ?>
                                <button disabled style="padding: 6px 12px; background: #ccc; color: white; border: none; border-radius: 4px; cursor: not-allowed; font-size: 0.9em;">‚úì Compl√©t√©e</button>
                            <?php endif; ?>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>
    </div>

    <!-- Weekly overview -->
    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 20px;">
        <h3>Aper√ßu de la semaine</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <?php
            $weekStart = (new DateTime('today'))->modify('-2 days');
            for ($i = 0; $i < 12; $i++) {
                $date = clone $weekStart;
                $date->modify("+$i days");
                $dateStr = $date->format('Y-m-d');
                $dayNum = $date->format('d');
                $dayName = ['lun', 'mar', 'mer', 'jeu', 'ven', 'sam', 'dim'];
                $dayShort = $dayName[(int)$date->format('N') - 1];
                $isToday = $dateStr === $today->format('Y-m-d');
                
                // Count tasks for this date
                $dayOfWeek = (int)$date->format('N');
                $recurringDay = [1 => 'mon', 2 => 'tue', 3 => 'wed', 4 => 'thu', 5 => 'fri', 6 => 'sat', 7 => 'sun'][$dayOfWeek] ?? null;
                
                $tasksCount = 0;
                $doneCount = 0;
                foreach ($projects as $project) {
                    $isMember = false;
                    foreach ($project['members'] as $member) {
                        if (strtolower($member['email']) === $email) {
                            $isMember = true;
                            break;
                        }
                    }
                    if (!$isMember) continue;
                    
                    foreach ($project['tasks'] as $task) {
                        if (strtolower($task['assigned_to']) !== $email) continue;
                        if ($task['is_recurring'] ?? false) {
                            if (in_array($recurringDay, $task['recurring_days'] ?? [])) {
                                $tasksCount++;
                                // For recurring tasks, pass the date to check specific day completion
                                if (is_task_complete($task, $dateStr)) {
                                    $doneCount++;
                                }
                            }
                        }
                    }
                }
                
                $isSelected = $dateStr === $selectedDate->format('Y-m-d');
                $bgColor = $isSelected ? '#007bff' : ($isToday ? '#e8f4f8' : 'white');
                $textColor = $isSelected ? 'white' : 'black';
                $border = $isToday ? '2px solid #007bff' : '1px solid #ddd';
                
                echo '<a href="?date=' . $dateStr . '" style="text-decoration: none; padding: 12px; background: ' . $bgColor . '; border: ' . $border . '; border-radius: 6px; color: ' . $textColor . '; text-align: center; cursor: pointer;">';
                echo '<div style="font-weight: bold; font-size: 0.9em;">' . strtoupper($dayShort) . '</div>';
                echo '<div style="font-size: 1.3em; font-weight: bold;">' . $dayNum . '</div>';
                echo '<div style="font-size: 0.85em; margin-top: 5px;">' . $doneCount . '/' . $tasksCount . '</div>';
                echo '</a>';
            }
            ?>
        </div>
    </div>
</section>

<?php include __DIR__ . '/includes/footer.php'; ?>

<style>
    .btn-secondary {
        background: #6c757d;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        text-decoration: none;
        display: inline-block;
    }
    .btn-secondary:hover {
        background: #5a6268;
    }
</style>

<?php include __DIR__ . '/includes/footer.php'; ?>

<script src="assets/app.js"></script>












'assets/app.js'
function addMemberRow() {
    const container = document.getElementById('members-container');
    if (!container) return;

    const div = document.createElement('div');
    div.className = 'member-row';
    div.innerHTML = `
        <input type="text" name="member_name[]" placeholder="Nom du membre" data-temp="true">
        <input type="email" name="member_email[]" placeholder="Email du membre" data-temp="true">
        <button type="button" class="btn-secondary btn-confirm" onclick="confirmMember(this)">‚úì Confirmer</button>
    `;
    container.appendChild(div);
    updateTaskAssigneeSelects();
}

function confirmMember(button) {
    const row = button.closest('.member-row');
    if (!row) return;

    const nameInput = row.querySelector('input[name="member_name[]"]');
    const emailInput = row.querySelector('input[name="member_email[]"]');
    const name = nameInput?.value.trim();
    const email = emailInput?.value.trim();

    if (!email || !name) {
        alert('Veuillez remplir le nom et l\'email du membre');
        return;
    }

    // Marquer comme confirm√©
    nameInput.removeAttribute('data-temp');
    emailInput.removeAttribute('data-temp');
    
    // Remplacer le bouton confirmer par un bouton supprimer
    button.innerHTML = '‚úï Supprimer';
    button.className = 'btn-secondary btn-remove';
    button.onclick = function() { removeMemberRow(this); };

    // Mettre √† jour les options dans les s√©lecteurs de t√¢ches
    updateTaskAssigneeSelects();
}

function removeMemberRow(button) {
    const row = button.closest('.member-row');
    if (row) {
        row.remove();
        updateTaskAssigneeSelects();
    }
}

function updateTaskAssigneeSelects() {
    // R√©cup√©rer tous les membres confirm√©s
    const members = [];
    const memberRows = document.querySelectorAll('.member-row');
    
    memberRows.forEach(row => {
        const nameInput = row.querySelector('input[name="member_name[]"]');
        const emailInput = row.querySelector('input[name="member_email[]"]');
        
        // Ne prendre que les membres confirm√©s (sans data-temp)
        if (nameInput && emailInput && !nameInput.hasAttribute('data-temp')) {
            members.push({
                name: nameInput.value,
                email: emailInput.value
            });
        }
    });

    // Mettre √† jour les s√©lecteurs dans les t√¢ches
    const taskRows = document.querySelectorAll('.task-row');
    taskRows.forEach(row => {
        const select = row.querySelector('select[name="task_assigned_to[]"]');
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Non assign√© --</option>';
            
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.email;
                option.textContent = member.name;
                if (member.email === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
    });
}

function addTaskRow() {
    const container = document.getElementById('tasks-container');
    if (!container) return;

    // R√©cup√©rer la liste des membres confirm√©s
    const members = [];
    const memberRows = document.querySelectorAll('.member-row');
    
    memberRows.forEach(row => {
        const nameInput = row.querySelector('input[name="member_name[]"]');
        const emailInput = row.querySelector('input[name="member_email[]"]');
        
        if (nameInput && emailInput && !nameInput.hasAttribute('data-temp')) {
            members.push({
                name: nameInput.value,
                email: emailInput.value
            });
        }
    });

    const div = document.createElement('div');
    div.className = 'task-row';
    
    let selectHTML = '<select name="task_assigned_to[]"><option value="">-- Non assign√© --</option>';
    members.forEach(member => {
        selectHTML += `<option value="${member.email}">${member.name}</option>`;
    });
    selectHTML += '</select>';
    
    div.innerHTML = `
        <input type="text" name="task_title[]" placeholder="Titre de la t√¢che">
        ${selectHTML}
        <select name="task_mode[]" class="task-mode-select" title="Mode d'√©valuation">
            <option value="status">Statut</option>
            <option value="bar">Barre</option>
        </select>
        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="checkbox" name="task_recurring[]" class="task-recurring-check" onchange="toggleRecurringDays(this)">
            <span>Hebdomadaire</span>
        </label>
        <button type="button" class="btn-secondary btn-remove" onclick="removeTaskRow(this)">‚úï Supprimer</button>
    `;
    container.appendChild(div);
}

function removeMemberRow(button) {
    const row = button.closest('.member-row');
    if (row) {
        row.remove();
        updateTaskAssigneeSelects();
    }
}

function removeTaskRow(button) {
    const row = button.closest('.task-row');
    if (row) {
        row.remove();
    }
}

function toggleRecurringDays(checkbox) {
    const taskRow = checkbox.closest('.task-row');
    if (!taskRow) return;
    
    // Get the task index to create proper indexed names
    const taskIndex = Array.from(document.querySelectorAll('.task-row')).indexOf(taskRow);
    
    let recurringDaysContainer = taskRow.querySelector('.recurring-days-container');
    
    if (checkbox.checked) {
        if (!recurringDaysContainer) {
            // Create the recurring days selector
            recurringDaysContainer = document.createElement('div');
            recurringDaysContainer.className = 'recurring-days-container';
            recurringDaysContainer.style.cssText = 'display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px; width: 100%;';
            
            const days = [
                { label: 'Lun', value: 'mon' },
                { label: 'Mar', value: 'tue' },
                { label: 'Mer', value: 'wed' },
                { label: 'Jeu', value: 'thu' },
                { label: 'Ven', value: 'fri' },
                { label: 'Sam', value: 'sat' },
                { label: 'Dim', value: 'sun' }
            ];
            
            days.forEach(day => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 4px; cursor: pointer;';
                label.innerHTML = `
                    <input type="checkbox" name="task_recurring_days[${taskIndex}][]" value="${day.value}">
                    <span>${day.label}</span>
                `;
                recurringDaysContainer.appendChild(label);
            });
            
            taskRow.appendChild(recurringDaysContainer);
        } else {
            recurringDaysContainer.style.display = 'flex';
        }
    } else {
        if (recurringDaysContainer) {
            recurringDaysContainer.style.display = 'none';
        }
    }
}

function addNewMemberRow() {
    const container = document.getElementById('members-new-container');
    if (!container) {
        // Si on n'est pas dans create_project, utiliser la m√©thode addMemberRow normale
        addMemberRow();
        return;
    }

    const div = document.createElement('div');
    div.className = 'member-row';
    div.innerHTML = `
        <input type="text" name="member_name[]" placeholder="Nom du membre" data-temp="true">
        <input type="email" name="member_email[]" placeholder="Email du membre" data-temp="true">
        <button type="button" class="btn-secondary btn-confirm" onclick="confirmMember(this)">‚úì Confirmer</button>
    `;
    container.appendChild(div);
}

function toggleInviteLink() {
    const box = document.getElementById('invite-link-box');
    if (!box) return;

    if (box.style.display === 'none' || box.style.display === '') {
        box.style.display = 'block';
    } else {
        box.style.display = 'none';
    }
}

function toggleTasksView(projectId) {
    const allTasksBtn = document.querySelector(`[data-project="${projectId}"][data-view="all"]`);
    const myTasksBtn = document.querySelector(`[data-project="${projectId}"][data-view="mine"]`);
    const allTasksTable = document.querySelector(`.table-wrapper[data-project="${projectId}"][data-table="all"]`);
    const myTasksTable = document.querySelector(`.table-wrapper[data-project="${projectId}"][data-table="mine"]`);

    if (!allTasksTable || !myTasksTable) return;

    if (allTasksTable.style.display === 'none' || allTasksTable.style.display === '') {
        allTasksTable.style.display = 'block';
        myTasksTable.style.display = 'none';
        if (allTasksBtn) allTasksBtn.classList.add('active');
        if (myTasksBtn) myTasksBtn.classList.remove('active');
    } else {
        myTasksTable.style.display = 'block';
        allTasksTable.style.display = 'none';
        if (myTasksBtn) myTasksBtn.classList.add('active');
        if (allTasksBtn) allTasksBtn.classList.remove('active');
    }
};

// Update task via AJAX without page reload
window.updateTaskAjax = function(form) {
    // Create FormData
    const formData = new FormData(form);
    const projectId = formData.get('project_id');
    const taskId = formData.get('task_id');
    const status = formData.get('status');
    const progress = formData.get('progress');
    let date = formData.get('date');
    
    // Check if this is a recurring task (date field exists but is empty, and there are day-buttons nearby)
    const dateInput = form.querySelector('input[name="date"]');
    const taskRow = form.closest('tr');
    const dayButtons = taskRow ? taskRow.querySelectorAll('.day-btn') : [];
    
    if (dateInput && !date && dayButtons.length > 0) {
        // This is a recurring task without a selected date
        // Auto-fill the closest day
        const dayMap = {'sun': 0, 'mon': 1, 'tue': 2, 'wed': 3, 'thu': 4, 'fri': 5, 'sat': 6};
        const today = new Date();
        const currentDay = today.getDay();
        
        let closestButton = null;
        let minDaysAhead = Infinity;
        
        dayButtons.forEach(btn => {
            const dayAttr = btn.getAttribute('data-day');
            const targetDayNum = dayMap[dayAttr];
            let daysToAdd = (targetDayNum - currentDay + 7) % 7;
            
            if (daysToAdd < minDaysAhead) {
                minDaysAhead = daysToAdd;
                closestButton = btn;
            }
        });
        
        if (closestButton) {
            const dayAttr = closestButton.getAttribute('data-day');
            const targetDayNum = dayMap[dayAttr];
            let daysToAdd = (targetDayNum - currentDay + 7) % 7;
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + daysToAdd);
            
            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const dateNum = String(targetDate.getDate()).padStart(2, '0');
            date = `${year}-${month}-${dateNum}`;
            
            // Update both the form input and the FormData
            dateInput.value = date;
            formData.set('date', date);
        }
    }
    
    console.log('Envoi AJAX:', {
        project_id: projectId,
        task_id: taskId,
        status: status,
        progress: progress,
        date: date
    });
    
    // Send via fetch with AJAX header
    fetch('update_task.php', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('R√©ponse re√ßue:', response.status);
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        console.log('Donn√©es JSON re√ßues:', data);
        
        if (data.success) {
            // Update all matching task rows in both "Mes t√¢ches" and "Toutes les t√¢ches" tables
            const allTaskRows = document.querySelectorAll(`tr[data-task-id="${taskId}"][data-project-id="${projectId}"]`);
            
            allTaskRows.forEach(row => {
                const td = row.querySelector('td:last-child'); // √âvaluation column
                if (td && status) {
                    // Status update
                    const select = td.querySelector('select');
                    if (select) {
                        select.value = status;
                        console.log('Status updated in row:', status);
                    }
                    
                    // Update row background color if task is now done
                    if (status === 'done') {
                        row.style.backgroundColor = '#e8f5e9';
                        row.classList.add('task-completed');
                    } else {
                        row.style.backgroundColor = 'transparent';
                        row.classList.remove('task-completed');
                    }
                } else if (td && progress !== undefined) {
                    // Progress update
                    const progressBar = td.querySelector('.progress-bar');
                    if (progressBar) {
                        const progressFill = progressBar.querySelector('.progress-fill');
                        const progressText = progressBar.querySelector('.progress-text');
                        if (progressFill) {
                            progressFill.style.width = progress + '%';
                        }
                        if (progressText) {
                            progressText.textContent = progress + '%';
                        }
                        console.log('Progress updated in row:', progress + '%');
                    }
                    
                    // Update row background color if task is now complete (100%)
                    if (progress >= 100) {
                        row.style.backgroundColor = '#e8f5e9';
                        row.classList.add('task-completed');
                    } else {
                        row.style.backgroundColor = 'transparent';
                        row.classList.remove('task-completed');
                    }
                }
            });
        }
    })
    .catch(error => {
        console.error('Error updating task:', error);
        alert('Erreur lors de la mise √† jour. Veuillez r√©essayer.');
    });
    
    return false;
};

// Initialiser les dropdowns avec le cr√©ateur au chargement
document.addEventListener('DOMContentLoaded', function() {
    updateTaskAssigneeSelects();
});

// Delete task via AJAX
window.deleteTaskAjax = function(projectId, taskId) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette t√¢che ?')) {
        return false;
    }
    
    const formData = new FormData();
    formData.append('project_id', projectId);
    formData.append('task_id', taskId);
    
    console.log('Suppression t√¢che:', { project_id: projectId, task_id: taskId });
    
    fetch('delete_task.php', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('R√©ponse re√ßue:', response.status);
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        console.log('Donn√©es JSON re√ßues:', data);
        
        if (data.success) {
            // Remove all matching task rows from both tables
            const allTaskRows = document.querySelectorAll(`tr[data-task-id="${taskId}"][data-project-id="${projectId}"]`);
            allTaskRows.forEach(row => {
                row.remove();
            });
            console.log('T√¢che supprim√©e');
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error deleting task:', error);
        alert('Erreur lors de la suppression. Veuillez r√©essayer.');
    });
    
    return false;
};

document.addEventListener('DOMContentLoaded', function() {
// Fonction pour basculer entre "Mes t√¢ches" et "Toutes les t√¢ches"
function toggleTasksView(projectId, view) {
const allTasksBtn = document.querySelector(`.btn-toggle[data-project="${projectId}"][data-view="all"]`);
const myTasksBtn = document.querySelector(`.btn-toggle[data-project="${projectId}"][data-view="mine"]`);
const allTasksTable = document.querySelector(`.table-wrapper[data-project="${projectId}"][data-table="all"]`);
const myTasksTable = document.querySelector(`.table-wrapper[data-project="${projectId}"][data-table="mine"]`);


    if (!allTasksTable || !myTasksTable) return;

    if (view === 'all') {
        allTasksTable.style.display = 'block';
        myTasksTable.style.display = 'none';
        allTasksBtn.classList.add('active');
        myTasksBtn.classList.remove('active');
    } else {
        myTasksTable.style.display = 'block';
        allTasksTable.style.display = 'none';
        myTasksBtn.classList.add('active');
        allTasksBtn.classList.remove('active');
    }
}

// Attacher les √©v√©nements √† tous les boutons toggle
document.querySelectorAll('.btn-toggle').forEach(btn => {
    btn.addEventListener('click', function() {
        const projectId = this.dataset.project;
        const view = this.dataset.view;
        toggleTasksView(projectId, view);
    });
});

// Initialisation : afficher "Mes t√¢ches" par d√©faut
document.querySelectorAll('.tasks-toggle').forEach(container => {
    const projectId = container.querySelector('.btn-toggle').dataset.project;
    toggleTasksView(projectId, 'mine');
});


});

/**
 * Update task progress for a specific day via AJAX
 * Used in weekly_view.php and day_view.php
 * Accepts either day abbreviation (mon-sun) or full date (YYYY-MM-DD)
 */
function updateDailyTaskProgress(projectId, taskId, dayOrDate, action, value = null) {
    const formData = new FormData();
    formData.append('project_id', projectId);
    formData.append('task_id', taskId);
    formData.append('day', dayOrDate);
    formData.append('action', action);
    if (value !== null) {
        formData.append('value', value);
    }
    
    fetch('update_task_daily.php', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Find the container with matching task-id and date/day
            let container = document.querySelector(`[data-task-id="${taskId}"][data-date="${dayOrDate}"]`);
            if (!container) {
                container = document.querySelector(`[data-task-id="${taskId}"][data-day="${dayOrDate}"]`);
            }
            
            // Fallback: search by just task-id and manually check date
            if (!container) {
                const allContainers = document.querySelectorAll(`[data-task-id="${taskId}"]`);
                for (let c of allContainers) {
                    const dataDate = c.getAttribute('data-date');
                    const dataDay = c.getAttribute('data-day');
                    if (dataDate === dayOrDate || dataDay === dayOrDate) {
                        container = c;
                        break;
                    }
                }
            }
            
            if (container) {
                // Update the UI within this container
                const progressBar = container.querySelector('.task-progress-bar');
                const progressText = container.querySelector('.task-progress-text');
                const incrementBtn = container.querySelector('.btn-increment-day');
                const completeBtn = container.querySelector('.btn-complete-day');
                
                if (progressBar) {
                    progressBar.style.width = data.progress + '%';
                    progressBar.textContent = data.progress > 15 ? data.progress + '%' : '';
                }
                if (progressText) {
                    progressText.textContent = data.progress + '%';
                }
                
                // If complete, disable buttons and update UI
                if (data.is_complete) {
                    // Update container background and border color
                    container.style.background = '#e8f8e8';
                    container.style.borderLeft = '4px solid #4caf50';
                    
                    if (incrementBtn) {
                        incrementBtn.disabled = true;
                        incrementBtn.style.opacity = '0.5';
                        incrementBtn.style.cursor = 'not-allowed';
                    }
                    if (completeBtn) {
                        completeBtn.disabled = true;
                        completeBtn.textContent = '‚úì Compl√©t√©e (' + data.progress + '%)';
                        completeBtn.style.opacity = '1';
                        completeBtn.style.cursor = 'not-allowed';
                    }
                }
                
                console.log('Progress updated successfully:', { taskId, dayOrDate, progress: data.progress });
            } else {
                console.warn('Container not found for task', taskId, 'date/day', dayOrDate);
                console.log('Available containers:', document.querySelectorAll('[data-task-id]').length);
            }
        } else {
            alert('Erreur: ' + (data.error || 'Mise √† jour √©chou√©e'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la mise √† jour');
    });
}

/**
 * Update task status via AJAX (Commencer, Terminer, Marquer compl√®te)
 * @param {string} projectId - Project ID
 * @param {string} taskId - Task ID
 * @param {string} status - New status (todo, in_progress, done)
 * @param {HTMLElement} button - The button element clicked
 * @param {string} date - Optional: Date in YYYY-MM-DD format for recurring tasks
 */
function updateTaskStatus(projectId, taskId, status, button, date = null) {
    if (!button) {
        console.error('Button element not provided');
        return;
    }

    const formData = new FormData();
    formData.append('project_id', projectId);
    formData.append('task_id', taskId);
    formData.append('status', status);
    if (date) {
        formData.append('date', date);
    }

    fetch('update_task.php', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Find the task container div
            const taskContainer = button.closest('[data-task-id]');
            if (!taskContainer) {
                console.error('Task container not found');
                return;
            }
            
            // Update the status badge - support both span and div with class
            let statusBadge = taskContainer.querySelector('span[style*="background"]');
            if (!statusBadge) {
                statusBadge = taskContainer.querySelector('.task-status-badge');
            }
            if (statusBadge) {
                const statusLabels = {
                    'todo': '‚è≥ √Ä faire',
                    'in_progress': 'üîÑ En cours',
                    'done': '‚úì Termin√©'
                };
                const statusInner = statusBadge.querySelector('strong') || statusBadge;
                statusInner.textContent = statusLabels[status] || status;
                
                // Update background color based on status
                let bgColor = '#007bff';
                if (status === 'done') {
                    bgColor = '#28a745';
                } else if (status === 'in_progress') {
                    bgColor = '#fd7e14';
                }
                statusBadge.style.background = bgColor;
            }
            
            // Update the background color of the task container
            if (status === 'done') {
                taskContainer.style.background = '#e8f8e8';
                taskContainer.style.borderLeftColor = '#28a745';
            } else if (status === 'in_progress') {
                taskContainer.style.background = '#fff4e8';
                taskContainer.style.borderLeftColor = '#fd7e14';
            } else if (status === 'todo') {
                taskContainer.style.background = '#e8f4f8';
                taskContainer.style.borderLeftColor = '#007bff';
            }
            
            // Update button state based on new status
            const parent = button.parentElement;
            
            if (status === 'done') {
                // Replace all action buttons with disabled "Compl√©t√©e" button
                parent.innerHTML = '<button disabled style="padding: 6px 12px; background: #ccc; color: white; border: none; border-radius: 4px; cursor: not-allowed; font-size: 0.85em;">‚úì Compl√©t√©e</button>';
            } else if (status === 'in_progress') {
                // Show both "Commencer" and "Terminer" or just "Terminer" based on current state
                // For now, keep the button state as is
            }
            
            // Optional: show a success message
            console.log('Task status updated to: ' + status);
        } else {
            alert('Erreur: ' + (data.error || 'Mise √† jour √©chou√©e'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la mise √† jour du statut');
    });
}

/**
 * Handle day selection for recurring tasks in dashboard
 * Shows/hides the task content form based on selected day
 * Loads the stored value for that day from daily_progress
 * 
 * If autoSelect is true, automatically selects the closest day (today or next occurrence)
 */
function selectTaskDay(button, projectId, taskId, taskMode, autoSelect = false) {
    // Get parent container (the div with all day buttons and content)
    const container = button.parentElement.parentElement;
    
    // Remove active state from all day buttons
    container.querySelectorAll('.day-btn').forEach(btn => {
        btn.style.background = '#f0f0f0';
        btn.style.color = '#333';
        btn.style.borderColor = '#ccc';
    });
    
    // Add active state to clicked button
    button.style.background = '#667eea';
    button.style.color = 'white';
    button.style.borderColor = '#667eea';
    
    // Show the task content div
    const contentDiv = container.querySelector('.task-day-content');
    if (contentDiv) {
        contentDiv.style.display = 'block';
        
        // Get the selected day
        const day = button.getAttribute('data-day');
        
        // Calculate the date for this day of week
        const dayMap = {'sun': 0, 'mon': 1, 'tue': 2, 'wed': 3, 'thu': 4, 'fri': 5, 'sat': 6};
        const targetDayNum = dayMap[day];
        const today = new Date();
        const currentDay = today.getDay();
        
        // Days to add to reach the target day
        let daysToAdd = (targetDayNum - currentDay + 7) % 7;
        if (daysToAdd === 0) {
            daysToAdd = 0; // Today is the target day
        }
        
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + daysToAdd);
        
        // Format as YYYY-MM-DD
        const year = targetDate.getFullYear();
        const month = String(targetDate.getMonth() + 1).padStart(2, '0');
        const dateNum = String(targetDate.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${dateNum}`;
        
        // Update the hidden date input in the form(s)
        contentDiv.querySelectorAll('input[name="date"]').forEach(input => {
            input.value = dateStr;
        });
        
        // Now fetch the current value for this date from daily_progress
        fetch('get_task_daily_progress.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `project_id=${projectId}&task_id=${taskId}&date=${dateStr}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update progress bar if in bar mode
                const progressFill = contentDiv.querySelector('.progress-fill');
                const progressText = contentDiv.querySelector('.progress-text');
                const progressInput = contentDiv.querySelector('input[name="progress"]');
                if (progressFill && progressText && progressInput) {
                    const progress = data.progress || 0;
                    progressFill.style.width = progress + '%';
                    progressText.textContent = progress > 15 ? progress + '%' : '';
                    progressInput.value = progress;
                }
                
                // Update status select if in status mode
                const statusSelect = contentDiv.querySelector('select[name="status"]');
                if (statusSelect && data.status) {
                    statusSelect.value = data.status;
                }
            }
        })
        .catch(error => {
            console.warn('Could not load task progress:', error);
            // Gracefully continue with default values
        });
    }
}

/**
 * Auto-select the closest day for a recurring task in dashboard
 * Finds today or the next occurrence and selects it
 */
function autoSelectClosestDay(container) {
    const buttons = container.querySelectorAll('.day-btn');
    if (buttons.length === 0) return;
    
    const dayMap = {'sun': 0, 'mon': 1, 'tue': 2, 'wed': 3, 'thu': 4, 'fri': 5, 'sat': 6};
    const today = new Date();
    const currentDay = today.getDay();
    
    let closestButton = null;
    let minDaysAhead = Infinity;
    
    // Find the button for today, or the closest future day
    buttons.forEach(btn => {
        const day = btn.getAttribute('data-day');
        const targetDayNum = dayMap[day];
        let daysToAdd = (targetDayNum - currentDay + 7) % 7;
        
        // Today gets priority (0 days ahead)
        if (daysToAdd < minDaysAhead) {
            minDaysAhead = daysToAdd;
            closestButton = btn;
        }
    });
    
    // Auto-click the closest button
    if (closestButton) {
        const projectId = closestButton.getAttribute('data-project-id') || 
                         closestButton.closest('[data-project-id]')?.getAttribute('data-project-id');
        const taskId = closestButton.getAttribute('data-task-id') || 
                      closestButton.closest('[data-task-id]')?.getAttribute('data-task-id');
        const taskMode = closestButton.getAttribute('data-task-mode') || 
                        closestButton.closest('[data-task-mode]')?.getAttribute('data-task-mode') || 'status';
        
        // Get the actual project_id and task_id from the form if available
        const form = closestButton.closest('[class*="task-day"]')?.querySelector('form');
        if (form) {
            const projectIdInput = form.querySelector('input[name="project_id"]');
            const taskIdInput = form.querySelector('input[name="task_id"]');
            if (projectIdInput) selectTaskDay(closestButton, projectIdInput.value, taskIdInput?.value, taskMode);
        } else {
            selectTaskDay(closestButton, projectId, taskId, taskMode);
        }
    }
}

// Auto-select closest day when page loads
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.day-btn').forEach(btn => {
        // Only auto-select if it's the first day-btn in its container group
        const parentContainer = btn.parentElement;
        if (parentContainer.querySelector('.day-btn') === btn) {
            autoSelectClosestDay(parentContainer);
        }
    });

    // Auto-fill date for forms in recurring tasks on dashboard tables
    document.querySelectorAll('input[name="date"][value=""]').forEach(dateInput => {
        // Check if this date input is in a row with day-buttons
        const form = dateInput.closest('form');
        if (!form) return;

        const taskRow = form.closest('tr');
        if (!taskRow) return;

        const dayButtons = taskRow.querySelectorAll('.day-btn');
        if (dayButtons.length === 0) return;

        // This is a recurring task - calculate the closest day date
        const dayMap = {'sun': 0, 'mon': 1, 'tue': 2, 'wed': 3, 'thu': 4, 'fri': 5, 'sat': 6};
        const today = new Date();
        const currentDay = today.getDay();

        let closestButton = null;
        let minDaysAhead = Infinity;

        dayButtons.forEach(btn => {
            const dayAttr = btn.getAttribute('data-day');
            const targetDayNum = dayMap[dayAttr];
            const daysToAdd = (targetDayNum - currentDay + 7) % 7;

            if (daysToAdd < minDaysAhead) {
                minDaysAhead = daysToAdd;
                closestButton = btn;
            }
        });

        if (closestButton && minDaysAhead < Infinity) {
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + minDaysAhead);

            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const dateNum = String(targetDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${dateNum}`;

            dateInput.value = dateStr;
            console.log(`Auto-filled date for task: ${dateStr}`);
        }
    });
});

/**
 * Copy invite link to clipboard
 */
function copyInviteLink(codeElement) {
    const link = codeElement.textContent.trim();
    
    // Use modern Clipboard API if available
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(link).then(() => {
            showCopyFeedback();
        }).catch(() => {
            fallbackCopyToClipboard(link);
        });
    } else {
        fallbackCopyToClipboard(link);
    }
}

/**
 * Fallback method for older browsers
 */
function fallbackCopyToClipboard(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    try {
        document.execCommand('copy');
        showCopyFeedback();
    } catch (err) {
        console.error('Fallback: Could not copy text', err);
    }
    document.body.removeChild(textarea);
}

/**
 * Show feedback message
 */
function showCopyFeedback() {
    const feedback = document.getElementById('copy-feedback');
    if (feedback) {
        feedback.style.display = 'inline-block';
        setTimeout(() => {
            feedback.style.display = 'none';
        }, 3000);
    }
}














'assets/style.css'
*,
*::before,
*::after {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f5f5f7;
    color: #222;
}

a {
    text-decoration: none;
    color: inherit;
}

.container {
    max-width: 960px;
    margin: 0 auto;
    padding: 0 16px;
}

/* Header */

.main-header {
    background: #ffffff;
    border-bottom: 1px solid #e2e2e2;
    position: sticky;
    top: 0;
    z-index: 10;
}

.header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
}

.logo a {
    font-weight: 700;
    font-size: 1.2rem;
}

.main-nav a {
    margin-left: 16px;
    font-size: 0.95rem;
}

.user-label {
    margin-left: 16px;
    font-style: italic;
}

/* Main */

.main-content {
    padding: 24px 0 40px;
}

/* Auth cards */

.auth-wrapper {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-top: 24px;
}

.auth-card {
    background: #ffffff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
}

.auth-card h1,
.auth-card h2 {
    margin-top: 0;
}

/* Forms */

.form-block {
    margin-top: 12px;
}

.form-group {
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-size: 0.9rem;
    margin-bottom: 4px;
}

.form-group input,
.form-group textarea,
.form-group select {
    padding: 8px 10px;
    border: 1px solid #d0d0d0;
    border-radius: 8px;
    font: inherit;
}

.form-group textarea {
    resize: vertical;
}

/* Buttons */

.btn-primary,
.btn-secondary,
.btn-logout,
.btn-link {
    display: inline-block;
    padding: 8px 14px;
    border-radius: 999px;
    font-size: 0.9rem;
    border: none;
    cursor: pointer;
}

.invite-link-btn {
    margin-top: 8px;
    margin-bottom: 8px;
}

.invite-link-box {
    background: #f0f4ff;
    border-radius: 10px;
    padding: 10px 12px;
    margin-bottom: 12px;
    font-size: 0.9rem;
}

.invite-link-box code {
    display: inline-block;
    padding: 4px 8px;
    background: #fff;
    border-radius: 6px;
    border: 1px dashed #6574cd;
    font-family: "SF Mono", Menlo, Monaco, Consolas, monospace;
}


.btn-primary {
    background: #007bff;
    color: #fff;
}

.btn-secondary {
    background: #e9ecef;
    color: #111;
}

.btn-logout {
    background: #ff4d4f;
    color: #fff;
}

.btn-link {
    background: transparent;
    color: #007bff;
    padding-left: 0;
}

/* Alerts */

.alert {
    padding: 10px 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    font-size: 0.9rem;
}

.alert-error {
    background: #ffe3e3;
    color: #8b0000;
}

.alert-success {
    background: #e6ffea;
    color: #256029;
}

/* Project cards */

.project-section {
    margin-top: 32px;
}

.project-card {
    background: #ffffff;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05);
    margin-bottom: 16px;
}

.project-card h3 {
    margin-top: 0;
}

.project-desc {
    font-size: 0.9rem;
    margin-bottom: 8px;
}

.project-meta {
    font-size: 0.85rem;
    color: #555;
}

/* Tables */

.table-wrapper {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    margin-top: 8px;
}

th,
td {
    border-bottom: 1px solid #eee;
    padding: 6px 4px;
    text-align: left;
}

th {
    font-weight: 600;
}

.my-task {
    background: #e8f5ff;
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    margin-left: 6px;
    white-space: nowrap;
    height: fit-content;
}

.badge-pending {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}

.badge-creator {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}


/* Members & tasks rows */

.member-row,
.task-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
}

.member-row input,
.task-row input,
.task-row select,
.member-row select {
    flex: 1;
}

.task-progress {
    flex: 0.8;
    min-width: 80px;
}

.member-row button,
.member-row .badge,
.task-row button {
    flex-shrink: 0;
    min-width: fit-content;
}

/* Form page */

.form-page h1 {
    margin-top: 0;
}

.hint {
    font-size: 0.85rem;
    color: #555;
}

.form-actions {
    margin-top: 16px;
    display: flex;
    gap: 12px;
    align-items: center;
}

/* Progress bars */

.progress-bar {
    position: relative;
    width: 100%;
    height: 24px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-fill {
    position: absolute;
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #66BB6A);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.progress-text {
    position: relative;
    font-size: 0.75rem;
    font-weight: 600;
    color: #333;
    z-index: 1;
}

/* Footer */

.main-footer {
    border-top: 1px solid #ddd;
    padding: 14px 0;
    background: #ffffff;
    font-size: 0.8rem;
    text-align: center;
}

/* Progress slider styling */
.progress-slider {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #e0e0e0;
    outline: none;
    cursor: pointer;
}

.progress-slider::-webkit-slider-thumb {
    appearance: none;
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #3498db;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.progress-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #3498db;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.tasks-toggle {
display: flex;
gap: 10px;
margin-bottom: 10px;
}

.btn-toggle {
padding: 6px 12px;
border: 1px solid #3498db;
background-color: #fff;
color: #3498db;
border-radius: 4px;
cursor: pointer;
font-size: 0.9rem;
transition: all 0.2s ease;
}


.btn-toggle.active {
background-color: #3498db;
color: #fff;
}

.btn-toggle:hover {
background-color: #2980b9;
color: #fff;
border-color: #2980b9;
}















'data/projects.json'
[]



'data/user.json'
[]










'includes/config.php'
<?php
// start session
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// data file path constants
define('DATA_DIR', __DIR__ . '/../data');
define('USERS_FILE', DATA_DIR . '/users.json');
define('PROJECTS_FILE', DATA_DIR . '/projects.json');




'includes/footer.php'
</main>
<footer class="main-footer">
    <div class="container">
        <p>WeShare - R√©partition √©quitable des t√¢ches</p>
    </div>
</footer>
<script src="assets/app.js"></script>
</body>

</html>









'includes/db.php'
<?php

$host = 'mysql-weshare.alwaysdata.net';
$db   = 'weshare_users';
$user = 'weshare_admin';
$pass = 'adminWeShare';

$options = [
    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    PDO::ATTR_EMULATE_PREPARES   => false,
];

try {
    // Cr√©ation de la connexion globale $pdo
    $pdo = new PDO("mysql:host=$host;dbname=$db;charset=utf8", $user, $pass, $options);
} catch (\PDOException $e) {
    // Si erreur on arr√™te tout
    die("Erreur de connexion base de donn√©es : " . $e->getMessage());
}
?>








'includes/footer.php'
</main>
<footer class="main-footer">
    <div class="container">
        <p>WeShare - R√©partition √©quitable des t√¢ches</p>
    </div>
</footer>
<script src="assets/app.js?v=<?= filemtime(__DIR__ . '/../assets/app.js') ?>"></script>
</body>

</html>









'includes/functions.php'
<?php
require_once __DIR__ . '/config.php';
require_once __DIR__ . '/db.php';

/**
 * JSON file read/write utilities
 */
function load_json(string $file): array
{
    if (!file_exists($file)) {
        return [];
    }
    $json = file_get_contents($file);
    $data = json_decode($json, true);
    return is_array($data) ? $data : [];
}

function save_json(string $file, array $data): void
{
    file_put_contents(
        $file,
        json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)
    );
}

/**
 * User-related functions
 */

function find_user_by_email(string $email): ?array
{
    global $pdo;

    $stmt = $pdo->prepare("SELECT id, nom as name, email, password FROM users WHERE email = ?");
    $stmt->execute([strtolower(trim($email))]);
    
    $user = $stmt->fetch();
    return $user ?: null;
}

function create_user(string $name, string $email, string $password): array
{
    global $pdo;

    if (find_user_by_email($email)) {
        throw new Exception("Cet email est d√©j√† utilis√©.");
    }

    $emailClean = strtolower(trim($email));
    $passwordHash = password_hash($password, PASSWORD_DEFAULT);

    $sql = "INSERT INTO users (nom, email, password) VALUES (?, ?, ?)";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$name, $emailClean, $passwordHash]);

    return [
        'id' => $pdo->lastInsertId(),
        'nom' => $name,
        'email' => $emailClean
    ];
}

function authenticate(string $email, string $password): ?array
{
    $user = find_user_by_email($email);
    if (!$user) {
        return null;
    }
    if (!password_verify($password, $user['password'])) {
        return null;
    }
    return $user;
}

function login_user(array $user): void
{
    $_SESSION['user'] = [
        'id' => $user['id'],
        'name' => $user['nom'],
        'email' => $user['email'],
    ];
}

function current_user(): ?array
{
    return $_SESSION['user'] ?? null;
}

function require_login(): void
{
    if (!current_user()) {
        header('Location: index.php');
        exit;
    }
}

/**
 * Project-related functions
 */

function get_full_user_projects(int $user_id): array {
    global $pdo;
    
    // On r√©cup√®re les ID des projets (cr√©√©s ou membre)
    $sql = "SELECT DISTINCT p.id 
            FROM projects p
            LEFT JOIN participants part ON p.id = part.project_id
            WHERE p.created_by = ? OR part.user_id = ?
            ORDER BY p.created_at DESC";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$user_id, $user_id]);
    $projectIds = $stmt->fetchAll(PDO::FETCH_COLUMN);

    if (empty($projectIds)) return [];

    $projects = [];

    foreach ($projectIds as $pid) {
        // Infos du projet
        $stmt = $pdo->prepare("SELECT p.id, p.nom as name, p.description, p.status, p.created_at,
                                      u.nom as creator_name, u.email as creator_email, p.created_by as creator_id
                               FROM projects p
                               JOIN users u ON p.created_by = u.id
                               WHERE p.id = ?");
        $stmt->execute([$pid]);
        $projData = $stmt->fetch();

        // Infos des membres
        $stmt = $pdo->prepare("SELECT u.nom as name, u.email 
                               FROM participants part
                               JOIN users u ON part.user_id = u.id
                               WHERE part.project_id = ?");
        $stmt->execute([$pid]);
        $members = $stmt->fetchAll();
        
        // On ajoute le cr√©ateur √† la liste des membres si pas pr√©sent
        $creatorInMembers = false;
        foreach ($members as $m) {
            if ($m['email'] === $projData['creator_email']) $creatorInMembers = true;
        }
        if (!$creatorInMembers) {
            array_unshift($members, ['name' => $projData['creator_name'], 'email' => $projData['creator_email']]);
        }
        $projData['members'] = $members;

        // Infos des taches
        $stmt = $pdo->prepare("SELECT t.*, u.email as assigned_email 
                               FROM tasks t 
                               LEFT JOIN users u ON t.assigned_to = u.id 
                               WHERE t.project_id = ?");
        $stmt->execute([$pid]);
        $dbTasks = $stmt->fetchAll();
        
        $tasks = [];
        foreach ($dbTasks as $t) {
            // On d√©code les JSON stock√©s en texte pour retrouver les tableaux php
            $tasks[] = [
                'id' => $t['id'],
                'title' => $t['titre'],
                'assigned_to' => $t['assigned_email'] ?? '', 
                'assigned_to_id' => $t['assigned_to'],
                'status' => $t['status'],
                'progress' => (int)$t['progress'],
                'mode' => $t['mode'],
                'is_recurring' => (bool)$t['is_recurring'],
                'recurring_days' => json_decode($t['recurring_days'] ?? '[]', true),
                'daily_progress' => json_decode($t['daily_progress'] ?? '[]', true),
                'daily_status' => json_decode($t['daily_status'] ?? '[]', true)
            ];
        }
        $projData['tasks'] = $tasks;

        $projects[] = $projData;
    }

    return $projects;
}


function generate_id(string $prefix = ''): string
{
    return uniqid($prefix, true);
}

/**
 * Get human-readable status label
 */
function status_label(string $status): string
{
    switch ($status) {
        case 'in_progress':
            return 'En cours';
        case 'done':
            return 'Termin√©';
        case 'todo':
        default:
            return '√Ä faire';
    }
}

/**
 * Check if task is complete (done or at 100%)
 * For recurring tasks, checks daily progress for the specific date, or checks ALL daily entries without a specific date
 */
function is_task_complete(array $task, ?string $specificDate = null): bool
{
    $mode = $task['mode'] ?? 'status';
    
    if (!($task['is_recurring'] ?? false)) {
        // Non-recurring task
        if ($mode === 'bar') {
            return ($task['progress'] ?? 0) >= 100;
        } else {
            return ($task['status'] ?? 'todo') === 'done';
        }
    }
    
    // Recurring task
    if ($specificDate) {
        // Check specific date for recurring task
        if ($mode === 'bar') {
            // For bar mode, check daily_progress
            $dailyProgress = $task['daily_progress'] ?? [];
            return ($dailyProgress[$specificDate] ?? 0) >= 100;
        } else {
            // For status mode, check daily_status first, then fallback to daily_progress
            $dailyStatus = $task['daily_status'] ?? [];
            if (isset($dailyStatus[$specificDate])) {
                return $dailyStatus[$specificDate] === 'done';
            }
            // Fallback to progress-based completion
            $dailyProgress = $task['daily_progress'] ?? [];
            return ($dailyProgress[$specificDate] ?? 0) >= 100;
        }
    }
    
    // No specific date for recurring task: check if all daily entries are complete
    if ($mode === 'bar') {
        // For bar mode: all must be >= 100
        $dailyProgress = $task['daily_progress'] ?? [];
        if (empty($dailyProgress)) {
            return false;
        }
        foreach ($dailyProgress as $progress) {
            if ($progress < 100) {
                return false;
            }
        }
        return true;
    } else {
        // For status mode: all must be 'done'
        $dailyStatus = $task['daily_status'] ?? [];
        if (empty($dailyStatus)) {
            return false;
        }
        foreach ($dailyStatus as $status) {
            if ($status !== 'done') {
                return false;
            }
        }
        return true;
    }
}

/**
 * Format recurring days for display
 */
function format_recurring_days(array $recurring_days): string
{
    if (empty($recurring_days)) {
        return '';
    }
    
    $dayLabels = [
        'mon' => 'Lun',
        'tue' => 'Mar',
        'wed' => 'Mer',
        'thu' => 'Jeu',
        'fri' => 'Ven',
        'sat' => 'Sam',
        'sun' => 'Dim'
    ];
    
    $labels = [];
    foreach ($recurring_days as $day) {
        if (isset($dayLabels[$day])) {
            $labels[] = $dayLabels[$day];
        }
    }
    
    return implode(', ', $labels);
}

/**
 * Get progress for a task on a specific day (by date string or day abbreviation)
 */
/**
 * Get daily progress/status for a task on a specific date/day
 * For bar mode: returns progress value (0-100)
 * For status mode: returns progress value if available, otherwise returns 0
 */
function get_daily_progress(array $task, ?string $dayOrDate = null): int
{
    if (!($task['is_recurring'] ?? false)) {
        return $task['progress'] ?? 0;
    }
    
    if (!$dayOrDate) {
        return 0;
    }
    
    $dailyProgress = $task['daily_progress'] ?? [];
    
    // If it's a date (YYYY-MM-DD format), try multiple lookups
    if (preg_match('/^\d{4}-\d{2}-\d{2}$/', $dayOrDate)) {
        // Try the date key directly
        if (isset($dailyProgress[$dayOrDate])) {
            return $dailyProgress[$dayOrDate];
        }
        
        // Fallback: try old format with "status_" prefix (for backward compatibility)
        $statusKey = "status_" . $dayOrDate;
        if (isset($dailyProgress[$statusKey])) {
            return $dailyProgress[$statusKey];
        }
        
        // Fallback: try matching by day of week
        try {
            $date = new DateTime($dayOrDate);
            $dayOfWeek = (int)$date->format('N'); // 1=Monday, 7=Sunday
            $dayToRecurring = [1 => 'mon', 2 => 'tue', 3 => 'wed', 4 => 'thu', 5 => 'fri', 6 => 'sat', 7 => 'sun'];
            $dayAbbr = $dayToRecurring[$dayOfWeek] ?? null;
            if ($dayAbbr && isset($dailyProgress[$dayAbbr])) {
                return $dailyProgress[$dayAbbr];
            }
        } catch (Exception $e) {
            // Invalid date format, continue
        }
        
        return 0;
    }
    
    // Otherwise assume it's a day abbreviation (mon, tue, etc)
    return $dailyProgress[$dayOrDate] ?? 0;
}

/**
 * Get daily status for a task on a specific date/day
 * For status mode: returns status string (todo/in_progress/done)
 * For bar mode: converts progress to status (100=done, 50=in_progress, else=todo)
 */
function get_daily_status(array $task, ?string $dayOrDate = null): string
{
    if (!($task['is_recurring'] ?? false)) {
        return $task['status'] ?? 'todo';
    }
    
    if (!$dayOrDate) {
        return 'todo';
    }
    
    $mode = $task['mode'] ?? 'status';
    
    // For status mode, check daily_status first
    if ($mode === 'status') {
        $dailyStatus = $task['daily_status'] ?? [];
        if (preg_match('/^\d{4}-\d{2}-\d{2}$/', $dayOrDate)) {
            if (isset($dailyStatus[$dayOrDate])) {
                return $dailyStatus[$dayOrDate];
            }
        } else {
            // day abbreviation
            if (isset($dailyStatus[$dayOrDate])) {
                return $dailyStatus[$dayOrDate];
            }
        }
    }
    
    // Fallback: convert progress to status for bar mode or if daily_status not found
    $progress = get_daily_progress($task, $dayOrDate);
    if ($progress >= 100) {
        return 'done';
    } elseif ($progress >= 50) {
        return 'in_progress';
    }
    return 'todo';
}

/**
 * Set progress for a task on a specific day (by date string or day abbreviation)
 */
function set_daily_progress(array &$task, ?string $dayOrDate, int $progress): void
{
    if (!($task['is_recurring'] ?? false)) {
        $task['progress'] = max(0, min(100, $progress));
        return;
    }
    
    if (!$dayOrDate) {
        return;
    }
    
    if (!isset($task['daily_progress'])) {
        $task['daily_progress'] = [];
    }
    
    $task['daily_progress'][$dayOrDate] = max(0, min(100, $progress));
}

/**
 * Get average progress for recurring task across all its days
 * Or total progress for non-recurring tasks
 */
function get_overall_progress(array $task): int
{
    if (!($task['is_recurring'] ?? false)) {
        return $task['progress'] ?? 0;
    }
    
    $dailyProgress = $task['daily_progress'] ?? [];
    if (empty($dailyProgress)) {
        return 0;
    }
    
    return (int)round(array_sum($dailyProgress) / count($dailyProgress));
}

/**
 * Migrate old daily_progress keys to new format (removes "status_" prefix)
 * This ensures old data with "status_2025-12-02" becomes "2025-12-02"
 */
function migrate_daily_progress_keys(array &$projects): void
{
    foreach ($projects as &$project) {
        foreach ($project['tasks'] ?? [] as &$task) {
            if (!isset($task['daily_progress']) || !is_array($task['daily_progress'])) {
                continue;
            }
            
            $newProgress = [];
            foreach ($task['daily_progress'] as $key => $value) {
                // Remove "status_" prefix if present
                if (strpos($key, 'status_') === 0) {
                    $newKey = substr($key, 7); // Remove "status_" prefix
                    $newProgress[$newKey] = $value;
                } else {
                    $newProgress[$key] = $value;
                }
            }
            
            $task['daily_progress'] = $newProgress;
        }
    }
}

function get_latest_daily_status($task) {
    if (!($task['is_recurring'] ?? false) || empty($task['daily_status'])) {
        return $task['status'] ?? 'todo';
    }
    // Cherche le statut du jour le plus proche (pass√© ou aujourd'hui)
    $today = date('Y-m-d');
    $closest = null;
    foreach ($task['daily_status'] as $date => $status) {
        if ($date <= $today && ($closest === null || $date > $closest)) {
            $closest = $date;
        }
    }
    return $closest ? $task['daily_status'][$closest] : $task['status'] ?? 'todo';
}

/**
 * Get the relevant date for a recurring task (today or next occurrence)
 * Returns the YYYY-MM-DD date string
 */
function get_relevant_date_for_recurring_task(array $task): ?string
{
    if (!($task['is_recurring'] ?? false)) {
        return null;
    }

    $dayMap = ['sun' => 0, 'mon' => 1, 'tue' => 2, 'wed' => 3, 'thu' => 4, 'fri' => 5, 'sat' => 6];
    $today = new DateTime();
    $currentDayNum = (int)$today->format('w'); // 0=Sun, 1=Mon, etc.

    // Find the next occurrence of this task
    $minDaysAhead = 7;
    $nextOccurrence = null;

    foreach ($task['recurring_days'] ?? [] as $day) {
        $targetDayNum = $dayMap[$day] ?? null;
        if ($targetDayNum === null) continue;
        
        $daysAhead = ($targetDayNum - $currentDayNum + 7) % 7;
        if ($daysAhead < $minDaysAhead) {
            $minDaysAhead = $daysAhead;
            $nextOccurrence = $daysAhead;
        }
    }

    if ($nextOccurrence !== null) {
        $relevantDate = new DateTime();
        $relevantDate->modify("+{$nextOccurrence} days");
        return $relevantDate->format('Y-m-d');
    }

    return null;
}

// Track user activity
function log_activity(?int $user_id, string $action, string $target, string $details = ''): void {
    global $pdo;
    try {
        $url = $_SERVER['REQUEST_URI'] ?? '';
        $sql = "INSERT INTO activity_logs (user_id, type_action, element_cible, page_url, details) VALUES (?, ?, ?, ?, ?)";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([$user_id, $action, $target, $url, $details]);
    } catch (Exception $e) {
        // Silencieux pour ne pas bloquer
    }
}












'includes/header.php'
<?php
require_once __DIR__ . '/functions.php';
$user = current_user();
$page_title = $page_title ?? 'WeShare';
?>
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title><?= htmlspecialchars($page_title) ?> - WeShare</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/style.css?v=<?= filemtime(__DIR__ . '/../assets/style.css') ?>">
</head>

<body>
    <header class="main-header">
        <div class="container header-inner">
            <div class="logo">
                <a href="dashboard.php">WeShare</a>
            </div>
            <nav class="main-nav">
                <?php if ($user): ?>
                    <a href="dashboard.php">Mes projets</a>
                    <a href="weekly_view.php">üìÖ Vue semaine</a>
                    <a href="stats_view.php">üìä Statistiques</a>
                    <a href="create_project.php">Cr√©er un projet</a>
                    <span class="user-label">Bonjour, <?= htmlspecialchars($user['name'] ?? '') ?></span>
                    <a href="logout.php" class="btn-logout">D√©connexion</a>
                <?php else: ?>
                    <a href="index.php">Connexion</a>
                <?php endif; ?>
            </nav>
        </div>
    </header>
    <main class="container main-content">


